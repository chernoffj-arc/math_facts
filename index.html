<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edison Math Facts Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-screen, .level-select, .question-screen, .results-screen, .teacher-view {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        input[type="text"], input[type="password"], input[type="number"], input[type="email"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .level-card.locked {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .level-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .question-display {
            text-align: center;
            padding: 40px 20px;
        }
        
        .question-text {
            font-size: 48px;
            color: #333;
            margin: 30px 0;
        }
        
        .timer {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .answer-input {
            font-size: 32px;
            text-align: center;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-summary {
            text-align: center;
            padding: 20px;
        }
        
        .results-summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .mastery-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
        }
        
        .mastery-basic {
            background: #ffc107;
            color: #333;
        }
        
        .mastery-accomplished {
            background: #28a745;
            color: white;
        }
        
        .mastery-mastery {
            background: #007bff;
            color: white;
        }
        
        .teacher-stats {
            margin-top: 20px;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect-count {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .question-text {
                font-size: 36px;
            }
            
            .answer-input {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Edison Math Facts Practice</h1>
        
        <!-- Login Screen -->
        <div class="login-screen active">
            <h2 style="text-align: center; margin-bottom: 20px;">Login</h2>
            <div id="login-error"></div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="login()" id="student-login-btn">Student Login</button>
                <button class="btn btn-secondary" onclick="teacherLogin()" id="teacher-login-btn">Teacher Login</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="showSignup()" style="background: #28a745;">Sign Up</button>
            </div>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                Create an account or login with your email
            </p>
        </div>
        
        <!-- Level Select Screen -->
        <div class="level-select">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Welcome, <span id="student-name"></span>!</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <p style="margin-bottom: 20px;">Choose your level:</p>
            <div class="level-grid" id="level-grid"></div>
        </div>
        
        <!-- Question Screen -->
        <div class="question-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">Question 1 of 10</div>
            </div>
            <div id="incorrect-count-display"></div>
            <div class="question-display">
                <div class="timer" id="timer">Time: 0.0s</div>
                <div class="question-text" id="question-text">5 + 3 = ?</div>
                <input type="number" class="answer-input" id="answer-input" oninput="checkAnswer()">
                <div id="feedback" style="margin-top: 20px; font-size: 24px; font-weight: bold; min-height: 30px;"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="endSession()">End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div class="results-screen">
            <div class="results-summary">
                <h2>üéâ Session Complete!</h2>
                <div id="mastery-badge"></div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-time">0.0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="incorrect-remaining">0</div>
                        <div class="stat-label">Questions to Master</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="backToLevelSelect()">Back to Levels</button>
                    <button class="btn" onclick="retryLevel()">Practice Again</button>
                </div>
            </div>
        </div>
        
        <!-- Teacher View -->
        <div class="teacher-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <div id="teacher-stats" class="loading">Loading student data...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD93cqPEEZ-zL2_CjbszQIBXPWLe2wRd8g",
          authDomain: "math-facts-62a94.firebaseapp.com",
          databaseURL: "https://math-facts-62a94-default-rtdb.firebaseio.com",
          projectId: "math-facts-62a94",
          storageBucket: "math-facts-62a94.firebasestorage.app",
          messagingSenderId: "39584139494",
          appId: "1:39584139494:web:52c8004c167d3172dc5327",
          measurementId: "G-5GDFKPWT4Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Global variables
        let currentUser = null;
        let isTeacher = false;
        let currentLevel = null;
        let currentQuestion = 0;
        let questions = [];
        let answers = [];
        let startTime = null;
        let timerInterval = null;
        let studentData = null;
        let incorrectQuestions = {}; // Track incorrect questions for current session
        
        // Level definitions
        const levels = {
            A: {
                name: 'Level A - Kindergarten',
                description: 'Addition & Subtraction to 5',
                operations: ['+', '-'],
                maxNumber: 5,
                unlocked: true
            },
            B: {
                name: 'Level B - Grade 1',
                description: 'Addition & Subtraction to 10',
                operations: ['+', '-'],
                maxNumber: 10,
                unlocked: false
            },
            C: {
                name: 'Level C - Grade 2',
                description: 'Facts to 18 & Multiplication to 5√ó5',
                operations: ['+', '-', '√ó', '√∑'],
                maxNumber: 18,
                multMax: 5,
                unlocked: false
            },
            D: {
                name: 'Level D - Grade 3',
                description: 'Multiplication & Division to 9√ó9',
                operations: ['√ó', '√∑'],
                maxNumber: 9,
                unlocked: false
            },
            E: {
                name: 'Level E - Grade 4',
                description: 'Multiplication & Division to 12√ó12',
                operations: ['√ó', '√∑'],
                maxNumber: 12,
                unlocked: false
            }
        };
        
        // Timing thresholds
        const timings = {
            MASTERY: 4,
            ACCOMPLISHED: 6,
            BASIC: 8
        };
        
        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
            }
        });
        
        async function showSignup() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Initialize user data in database
                await database.ref('users/' + user.uid).set({
                    email: user.email,
                    isTeacher: false,
                    createdAt: new Date().toISOString(),
                    levels: {
                        A: { unlocked: true, mastery: null, attempts: [], incorrectQuestions: {} },
                        B: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        C: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        D: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        E: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} }
                    }
                });
                
                errorDiv.innerHTML = '<div class="success-message">Account created successfully!</div>';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        
        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            try {
                document.getElementById('student-login-btn').disabled = true;
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                isTeacher = false;
                
                await loadUserData();
                showLevelSelect();
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('student-login-btn').disabled = false;
            }
        }
        
        async function teacherLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            try {
                document.getElementById('teacher-login-btn').disabled = true;
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user is a teacher
                const snapshot = await database.ref('users/' + currentUser.uid + '/isTeacher').once('value');
                isTeacher = snapshot.val() === true;
                
                if (!isTeacher) {
                    // User is not authorized as a teacher
                    await auth.signOut();
                    currentUser = null;
                    errorDiv.innerHTML = '<div class="error-message">This account is not authorized for teacher access. Please contact an administrator to request teacher privileges.</div>';
                    document.getElementById('teacher-login-btn').disabled = false;
                    return;
                }
                
                showTeacherView();
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('teacher-login-btn').disabled = false;
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            const snapshot = await database.ref('users/' + currentUser.uid).once('value');
            studentData = snapshot.val();
            
            // Initialize if no data exists
            if (!studentData || !studentData.levels) {
                studentData = {
                    email: currentUser.email,
                    isTeacher: false,
                    levels: {
                        A: { unlocked: true, mastery: null, attempts: [], incorrectQuestions: {} },
                        B: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        C: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        D: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} },
                        E: { unlocked: false, mastery: null, attempts: [], incorrectQuestions: {} }
                    }
                };
                await database.ref('users/' + currentUser.uid).set(studentData);
            }
            
            // Ensure each level has incorrectQuestions
            for (let levelKey in studentData.levels) {
                if (!studentData.levels[levelKey].incorrectQuestions) {
                    studentData.levels[levelKey].incorrectQuestions = {};
                }
            }
        }
        
        async function logout() {
            await auth.signOut();
            currentUser = null;
            isTeacher = false;
            studentData = null;
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            showScreen('login-screen');
        }
        
        function showScreen(screenClass) {
            document.querySelectorAll('.login-screen, .level-select, .question-screen, .results-screen, .teacher-view').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('.' + screenClass).classList.add('active');
        }
        
        function showLevelSelect() {
            if (!studentData) return;
            
            document.getElementById('student-name').textContent = currentUser.email.split('@')[0];
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            
            const studentLevels = studentData.levels;
            
            for (let levelKey in levels) {
                const level = levels[levelKey];
                const studentLevel = studentLevels[levelKey];
                const card = document.createElement('div');
                card.className = 'level-card' + (studentLevel.unlocked ? '' : ' locked');
                
                let masteryText = '';
                if (studentLevel.mastery) {
                    masteryText = `<div style="font-size: 14px; margin-top: 10px;">${studentLevel.mastery}</div>`;
                }
                
                // Count incorrect questions
                const incorrectCount = Object.keys(studentLevel.incorrectQuestions || {}).length;
                let incorrectText = '';
                if (incorrectCount > 0) {
                    incorrectText = `<div style="font-size: 12px; margin-top: 5px; background: rgba(255,255,255,0.3); padding: 5px; border-radius: 5px;">üìù ${incorrectCount} to master</div>`;
                }
                
                card.innerHTML = `
                    <h3>${level.name}</h3>
                    <p style="font-size: 14px;">${level.description}</p>
                    ${masteryText}
                    ${incorrectText}
                `;
                
                if (studentLevel.unlocked) {
                    card.onclick = () => startLevel(levelKey);
                }
                
                grid.appendChild(card);
            }
            
            showScreen('level-select');
        }
        
        function startLevel(levelKey) {
            currentLevel = levelKey;
            currentQuestion = 0;
            answers = [];
            incorrectQuestions = {}; // Reset session incorrect questions
            questions = generateQuestions(levelKey);
            
            // Display incorrect question count
            const incorrectCount = Object.keys(studentData.levels[levelKey].incorrectQuestions || {}).length;
            const displayDiv = document.getElementById('incorrect-count-display');
            if (incorrectCount > 0) {
                displayDiv.innerHTML = `<div class="incorrect-count">üìù You have ${incorrectCount} question${incorrectCount !== 1 ? 's' : ''} to master in this level</div>`;
            } else {
                displayDiv.innerHTML = '';
            }
            
            showNextQuestion();
            showScreen('question-screen');
        }
        
        function generateQuestions(levelKey) {
            const level = levels[levelKey];
            const studentLevel = studentData.levels[levelKey];
            const questionSet = [];
            
            // Get incorrect questions from Firebase
            const storedIncorrect = studentLevel.incorrectQuestions || {};
            const incorrectArray = Object.keys(storedIncorrect).map(key => {
                const parts = key.split('|');
                return {
                    num1: parseInt(parts[0]),
                    num2: parseInt(parts[1]),
                    op: parts[2],
                    answer: parseInt(parts[3]),
                    fromIncorrectList: true
                };
            });
            
            // Determine how many questions to pull from incorrect list
            const incorrectCount = incorrectArray.length;
            let incorrectToUse = 0;
            if (incorrectCount >= 3) {
                incorrectToUse = 3;
            } else if (incorrectCount === 2) {
                incorrectToUse = 2;
            } else if (incorrectCount === 1) {
                incorrectToUse = 1;
            }
            
            // Add questions from incorrect list
            for (let i = 0; i < incorrectToUse && i < incorrectArray.length; i++) {
                questionSet.push(incorrectArray[i]);
            }
            
            // Generate new questions for the rest
            const newQuestionCount = 10 - incorrectToUse;
            for (let i = 0; i < newQuestionCount; i++) {
                questionSet.push(generateSingleQuestion(level));
            }
            
            // Shuffle questions
            return questionSet.sort(() => Math.random() - 0.5);
        }
        
        function generateSingleQuestion(level) {
            const op = level.operations[Math.floor(Math.random() * level.operations.length)];
            let num1, num2, answer;
            
            if (op === '+') {
                answer = Math.floor(Math.random() * (level.maxNumber + 1));
                num1 = Math.floor(Math.random() * (answer + 1));
                num2 = answer - num1;
            } else if (op === '-') {
                num1 = Math.floor(Math.random() * (level.maxNumber + 1));
                num2 = Math.floor(Math.random() * (num1 + 1));
                answer = num1 - num2;
            } else if (op === '√ó') {
                const max = level.multMax || level.maxNumber;
                num1 = Math.floor(Math.random() * max) + 1;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = num1 * num2;
            } else if (op === '√∑') {
                const max = level.multMax || level.maxNumber;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = Math.floor(Math.random() * max) + 1;
                num1 = num2 * answer;
            }
            
            return { num1, num2, op, answer, fromIncorrectList: false };
        }
        
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }
            
            const q = questions[currentQuestion];
            document.getElementById('question-text').textContent = `${q.num1} ${q.op} ${q.num2} = ?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer-input').focus();
            
            const progress = ((currentQuestion) / questions.length) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
        }
        
        function updateTimer() {
            const elapsed = (Date.now() - startTime) / 1000;
            document.getElementById('timer').textContent = `Time: ${elapsed.toFixed(1)}s`;
        }
        
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            const q = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            
            if (document.getElementById('answer-input').value === '') {
                feedback.textContent = '';
                feedback.style.color = '';
                return;
            }
            
            if (userAnswer === q.answer) {
                feedback.textContent = '‚úì Correct!';
                feedback.style.color = '#28a745';
                
                clearInterval(timerInterval);
                const timeTaken = (Date.now() - startTime) / 1000;
                
                answers.push({
                    question: q,
                    userAnswer: userAnswer,
                    correct: true,
                    time: timeTaken
                });
                
                // Remove from incorrect list if it was from there
                if (q.fromIncorrectList) {
                    const key = `${q.num1}|${q.num2}|${q.op}|${q.answer}`;
                    delete incorrectQuestions[key];
                }
                
                setTimeout(() => {
                    currentQuestion++;
                    showNextQuestion();
                }, 500);
            } else {
                const answerStr = userAnswer.toString();
                const correctStr = q.answer.toString();
                
                if (answerStr.length >= correctStr.length && userAnswer !== q.answer) {
                    feedback.innerHTML = `‚úó Incorrect. The answer is <strong>${q.answer}</strong>`;
                    feedback.style.color = '#dc3545';
                    
                    clearInterval(timerInterval);
                    const timeTaken = (Date.now() - startTime) / 1000;
                    
                    answers.push({
                        question: q,
                        userAnswer: userAnswer,
                        correct: false,
                        time: timeTaken
                    });
                    
                    // Add to incorrect questions list for this session
                    const key = `${q.num1}|${q.num2}|${q.op}|${q.answer}`;
                    incorrectQuestions[key] = true;
                    
                    setTimeout(() => {
                        currentQuestion++;
                        showNextQuestion();
                    }, 2000);
                }
            }
        }
        
        async function showResults() {
            clearInterval(timerInterval);
            
            const correctCount = answers.filter(a => a.correct).length;
            const totalTime = answers.reduce((sum, a) => sum + a.time, 0);
            const avgTime = totalTime / answers.length;
            const accuracy = (correctCount / answers.length) * 100;
            
            // Update Firebase incorrect questions list
            const levelRef = database.ref('users/' + currentUser.uid + '/levels/' + currentLevel);
            const currentIncorrect = studentData.levels[currentLevel].incorrectQuestions || {};
            
            // Add new incorrect questions
            for (let key in incorrectQuestions) {
                currentIncorrect[key] = true;
            }
            
            // Remove questions that were answered correctly this session
            for (let answer of answers) {
                if (answer.correct && answer.question.fromIncorrectList) {
                    const key = `${answer.question.num1}|${answer.question.num2}|${answer.question.op}|${answer.question.answer}`;
                    delete currentIncorrect[key];
                }
            }
            
            // Save updated incorrect questions to Firebase
            await levelRef.child('incorrectQuestions').set(currentIncorrect);
            studentData.levels[currentLevel].incorrectQuestions = currentIncorrect;
            
            // Count remaining incorrect questions
            const remainingIncorrect = Object.keys(currentIncorrect).length;
            
            // Determine mastery level
            // To achieve mastery, must have no incorrect questions AND meet time/accuracy requirements
            let mastery = null;
            if (accuracy >= 80 && remainingIncorrect === 0) {
                if (avgTime <= timings.MASTERY) {
                    mastery = 'MASTERY';
                } else if (avgTime <= timings.ACCOMPLISHED) {
                    mastery = 'ACCOMPLISHED';
                } else if (avgTime <= timings.BASIC) {
                    mastery = 'BASIC';
                }
            }
            
            // Prepare attempt data
            const attemptData = {
                date: new Date().toISOString(),
                correctCount: correctCount,
                avgTime: avgTime,
                accuracy: accuracy,
                mastery: mastery,
                remainingIncorrect: remainingIncorrect,
                answers: answers.map(a => ({
                    question: `${a.question.num1} ${a.question.op} ${a.question.num2}`,
                    correctAnswer: a.question.answer,
                    userAnswer: a.userAnswer,
                    correct: a.correct,
                    time: a.time,
                    wasFromIncorrectList: a.question.fromIncorrectList || false
                }))
            };
            
            // Update Firebase
            // Add attempt
            await levelRef.child('attempts').push(attemptData);
            
            // Update mastery level only if achieved
            if (mastery) {
                const currentMastery = studentData.levels[currentLevel].mastery;
                if (!currentMastery || 
                    (mastery === 'MASTERY') ||
                    (mastery === 'ACCOMPLISHED' && currentMastery === 'BASIC')) {
                    await levelRef.child('mastery').set(mastery);
                    studentData.levels[currentLevel].mastery = mastery;
                }
            }
            
            // Unlock next level if ACCOMPLISHED or MASTERY
            if (mastery === 'ACCOMPLISHED' || mastery === 'MASTERY') {
                const levelKeys = Object.keys(levels);
                const currentIndex = levelKeys.indexOf(currentLevel);
                if (currentIndex < levelKeys.length - 1) {
                    const nextLevel = levelKeys[currentIndex + 1];
                    await database.ref('users/' + currentUser.uid + '/levels/' + nextLevel + '/unlocked').set(true);
                    studentData.levels[nextLevel].unlocked = true;
                }
            }
            
            // Display results
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('avg-time').textContent = avgTime.toFixed(1) + 's';
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + '%';
            document.getElementById('incorrect-remaining').textContent = remainingIncorrect;
            
            const badgeDiv = document.getElementById('mastery-badge');
            if (mastery) {
                badgeDiv.innerHTML = `<div class="mastery-badge mastery-${mastery.toLowerCase()}">${mastery}</div>`;
            } else if (remainingIncorrect > 0) {
                badgeDiv.innerHTML = `<p style="color: #666;">You still have ${remainingIncorrect} question${remainingIncorrect !== 1 ? 's' : ''} to master. Keep practicing!</p>`;
            } else if (accuracy < 80) {
                badgeDiv.innerHTML = '<p style="color: #666;">You need 80% accuracy to achieve mastery. Keep practicing!</p>';
            } else {
                badgeDiv.innerHTML = '<p style="color: #666;">Work on your speed to achieve mastery!</p>';
            }
            
            showScreen('results-screen');
        }
        
        function endSession() {
            if (confirm('Are you sure you want to end this session? Your progress will not be saved.')) {
                clearInterval(timerInterval);
                backToLevelSelect();
            }
        }
        
        function backToLevelSelect() {
            showLevelSelect();
        }
        
        function retryLevel() {
            startLevel(currentLevel);
        }
        
        async function showTeacherView() {
            const statsDiv = document.getElementById('teacher-stats');
            statsDiv.innerHTML = '<div class="loading">Loading student data...</div>';
            
            try {
                const snapshot = await database.ref('users').once('value');
                const allUsers = snapshot.val();
                
                let html = '<h3>Student Progress Overview</h3>';
                
                if (!allUsers) {
                    html += '<p style="color: #666; padding: 20px;">No student data available yet.</p>';
                } else {
                    for (let userId in allUsers) {
                        const user = allUsers[userId];
                        if (user.isTeacher) continue; // Skip teachers
                        
                        html += `<div class="student-card">
                            <h4>${user.email || 'Unknown Student'}</h4>`;
                        
                        if (user.levels) {
                            for (let levelKey in user.levels) {
                                const level = user.levels[levelKey];
                                const levelInfo = levels[levelKey];
                                
                                if (level.attempts && typeof level.attempts === 'object') {
                                    const attemptsArray = Object.values(level.attempts);
                                    if (attemptsArray.length > 0) {
                                        const lastAttempt = attemptsArray[attemptsArray.length - 1];
                                        const incorrectCount = Object.keys(level.incorrectQuestions || {}).length;
                                        html += `
                                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                                <strong>${levelInfo.name}</strong>: 
                                                ${level.mastery ? `<span class="mastery-badge mastery-${level.mastery.toLowerCase()}" style="font-size: 12px; padding: 3px 10px;">${level.mastery}</span>` : 'In Progress'}
                                                <br>
                                                <small>Last: ${lastAttempt.correctCount}/10 correct, ${lastAttempt.avgTime.toFixed(1)}s avg, ${attemptsArray.length} attempts</small>
                                                ${incorrectCount > 0 ? `<br><small style="color: #dc3545;">üìù ${incorrectCount} questions to master</small>` : ''}
                                            </div>`;
                                    }
                                }
                            }
                        }
                        
                        html += '</div>';
                    }
                }
                
                statsDiv.innerHTML = html;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error-message">Error loading student data: ${error.message}</div>`;
            }
            
            showScreen('teacher-view');
        }
    </script>
</body>
</html>
