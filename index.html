<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edison Math Facts Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-screen, .level-select, .question-screen, .results-screen, .teacher-view, .signup-screen, .countdown-screen, .student-detail-screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-teacher {
            background: #28a745;
        }
        
        .btn-teacher:hover {
            background: #218838;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        input[type="text"], input[type="password"], input[type="number"], input[type="email"], select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        select {
            background: white;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .level-card.locked {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .level-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .question-display {
            text-align: center;
            padding: 40px 20px;
        }
        
        .question-text {
            font-size: 48px;
            color: #333;
            margin: 30px 0;
        }
        
        .timer {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .timer-hidden {
            visibility: hidden;
        }
        
        .answer-input {
            font-size: 32px;
            text-align: center;
            max-width: 200px;
            margin: 0 auto;
        }
        
        /* Number Pad Styles */
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 280px;
            margin: 20px auto;
        }
        
        .num-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .num-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .num-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .num-btn.clear-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            font-size: 18px;
        }
        
        .num-btn.clear-btn:hover {
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
        }
        
        .num-btn.backspace-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
            font-size: 22px;
        }
        
        .num-btn.backspace-btn:hover {
            box-shadow: 0 6px 12px rgba(255, 193, 7, 0.4);
        }
        
        .num-btn.zero-btn {
            grid-column: 2;
        }
        
        .input-method-hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-summary {
            text-align: center;
            padding: 20px;
        }
        
        .results-summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .mastery-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
        }
        
        .mastery-basic {
            background: #ffc107;
            color: #333;
        }
        
        .mastery-accomplished {
            background: #28a745;
            color: white;
        }
        
        .mastery-mastery {
            background: #007bff;
            color: white;
        }
        
        .teacher-stats {
            margin-top: 20px;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect-count {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .mastery-progress {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .instructions-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions-section ul {
            margin-left: 20px;
            color: #555;
        }
        
        .instructions-section li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .pilot-banner {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .countdown-display {
            text-align: center;
            padding: 60px 20px;
        }
        
        .countdown-number {
            font-size: 120px;
            color: #667eea;
            font-weight: bold;
            animation: pulse 1s ease-in-out infinite;
        }
        
        .countdown-text {
            font-size: 24px;
            color: #666;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .level-progress-detail {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
            font-size: 11px;
        }
        
        .level-progress-item {
            background: rgba(255,255,255,0.2);
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
        }
        
        .level-progress-item.achieved {
            background: rgba(40, 167, 69, 0.8);
        }
        
        .reset-controls {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .reset-controls select {
            width: auto;
            margin: 0;
            padding: 6px 10px;
            font-size: 14px;
        }
        
        .attempt-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .attempt-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
        }
        
        .attempt-item.mastery-achieved {
            border-left-color: #007bff;
        }
        
        .attempt-item.accomplished-achieved {
            border-left-color: #28a745;
        }
        
        .attempt-item.basic-achieved {
            border-left-color: #ffc107;
        }
        
        .attempt-questions {
            margin-top: 10px;
            font-size: 12px;
        }
        
        .attempt-question {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
            background: #e9ecef;
        }
        
        .attempt-question.correct {
            background: #d4edda;
            color: #155724;
        }
        
        .attempt-question.incorrect {
            background: #f8d7da;
            color: #721c24;
        }
        
        .back-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 15px;
            display: inline-block;
        }
        
        .back-link:hover {
            color: #5568d3;
        }
        
        .answer-time-display {
            font-size: 18px;
            color: #667eea;
            margin-top: 5px;
        }
        
        .achievement-indicator {
            font-size: 14px;
            margin-top: 8px;
            padding: 5px 12px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .achievement-mastery {
            background: #007bff;
            color: white;
        }
        
        .achievement-accomplished {
            background: #28a745;
            color: white;
        }
        
        .achievement-basic {
            background: #ffc107;
            color: #333;
        }
        
        .loading-status {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .question-text {
                font-size: 36px;
            }
            
            .answer-input {
                font-size: 24px;
            }
            
            .countdown-number {
                font-size: 80px;
            }
            
            .level-progress-detail {
                flex-direction: column;
            }
            
            .number-pad {
                max-width: 240px;
                gap: 8px;
            }
            
            .num-btn {
                padding: 15px;
                font-size: 24px;
                min-height: 60px;
            }
            
            .num-btn.clear-btn {
                font-size: 14px;
            }
            
            .num-btn.backspace-btn {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Edison Math Facts Practice</h1>
        
        <!-- Login Screen -->
        <div class="login-screen active">
            <div class="pilot-banner">
                üöÄ Pilot Program - Currently available for Grade 2 students
            </div>
            
            <h2 style="text-align: center; margin-bottom: 20px;">Welcome!</h2>
            
            <!-- Instructions Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('teachers-tab')">üë©‚Äçüè´ For Teachers</button>
                <button class="tab" onclick="switchTab('parents-tab')">üë®‚Äçüë©‚Äçüëß For Parents & Students</button>
            </div>
            
            <div id="teachers-tab" class="tab-content active">
                <div class="instructions-section">
                    <h3>üë©‚Äçüè´ Teacher Instructions</h3>
                    <ul>
                        <li><strong>Sign up as a teacher</strong> using the "Teacher Sign Up" button below. Select your grade level during registration.</li>
                        <li><strong>Share your email</strong> with students/parents so they can join your class when they sign up.</li>
                        <li><strong>Track student progress</strong> through your Teacher Dashboard, which shows mastery levels and practice statistics for each student in your class.</li>
                        <li><strong>Reset student levels</strong> if needed using the controls in the dashboard.</li>
                        <li><strong>Mastery levels:</strong> Students achieve BASIC, ACCOMPLISHED, or MASTERY based on accuracy (‚â•80%) and speed. Only MASTERY unlocks the next level.</li>
                        <li><strong>Speed matters:</strong> Answers must be both correct AND fast enough to count as mastered.</li>
                        <li><strong>Questions per round</strong> vary by level (10-19 questions).</li>
                    </ul>
                </div>
            </div>
            
            <div id="parents-tab" class="tab-content">
                <div class="instructions-section">
                    <h3>üë®‚Äçüë©‚Äçüëß Parent & Student Instructions</h3>
                    <ul>
                        <li><strong>Sign up with your teacher's email</strong> to join their class. Ask your teacher for their email address.</li>
                        <li><strong>Your grade level</strong> is automatically set based on your teacher's class.</li>
                        <li><strong>Practice math facts</strong> by selecting a level and answering questions as quickly and accurately as you can.</li>
                        <li><strong>Speed matters:</strong> You must answer correctly AND quickly for a question to count as mastered.</li>
                        <li><strong>5-second countdown</strong> gives you time to get ready before each practice session starts.</li>
                        <li><strong>Master all questions</strong> in a level with 80%+ accuracy to earn mastery badges.</li>
                        <li><strong>Unlock new levels</strong> by achieving MASTERY status (fast answers + high accuracy + all questions mastered).</li>
                    </ul>
                </div>
            </div>
            
            <div id="login-error"></div>
            <div id="login-status" class="loading-status"></div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="login()" id="student-login-btn" disabled>Student Login</button>
                <button class="btn btn-secondary" onclick="teacherLogin()" id="teacher-login-btn" disabled>Teacher Login</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="showSignupScreen('student')" id="student-signup-btn" style="background: #17a2b8;" disabled>Student Sign Up</button>
                <button class="btn btn-teacher" onclick="showSignupScreen('teacher')" id="teacher-signup-btn" disabled>Teacher Sign Up</button>
            </div>
        </div>
        
        <!-- Signup Screen -->
        <div class="signup-screen">
            <h2 style="text-align: center; margin-bottom: 20px;" id="signup-title">Sign Up</h2>
            <div id="signup-error"></div>
            
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Create a password (min 6 characters)">
            </div>
            
            <div class="form-group">
                <label for="signup-name">Name</label>
                <input type="text" id="signup-name" placeholder="Enter your name">
            </div>
            
            <!-- Teacher-specific field -->
            <div class="form-group" id="teacher-grade-group" style="display: none;">
                <label for="teacher-grade">Your Class Grade Level</label>
                <select id="teacher-grade">
                    <option value="">Select grade level...</option>
                    <option value="K">Kindergarten</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                </select>
            </div>
            
            <!-- Student-specific fields -->
            <div class="form-group" id="student-teacher-group" style="display: none;">
                <label for="student-teacher-email">Teacher's Email</label>
                <input type="email" id="student-teacher-email" placeholder="Enter your teacher's email">
                <small style="color: #666;">Your grade level will be set based on your teacher's class.</small>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="completeSignup()" id="signup-btn">Create Account</button>
                <button class="btn btn-secondary" onclick="backToLogin()">Back to Login</button>
            </div>
        </div>
        
        <!-- Level Select Screen -->
        <div class="level-select">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Welcome, <span id="student-name"></span>!</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <p style="margin-bottom: 20px;">Choose your level:</p>
            <div class="level-grid" id="level-grid"></div>
        </div>
        
        <!-- Countdown Screen -->
        <div class="countdown-screen">
            <div class="countdown-display">
                <div class="countdown-text">Get Ready!</div>
                <div class="countdown-number" id="countdown-number">5</div>
                <div class="countdown-text" id="countdown-level-name"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="cancelCountdown()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Question Screen -->
        <div class="question-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">Question 1 of 10</div>
            </div>
            <div id="incorrect-count-display"></div>
            <div class="question-display">
                <div class="timer timer-hidden" id="timer">Time: 0.0s</div>
                <div class="question-text" id="question-text">5 + 3 = ?</div>
                <input type="number" class="answer-input" id="answer-input" oninput="checkAnswer()" inputmode="none">
                <div class="input-method-hint">Type or tap the numbers below</div>
                
                <!-- Number Pad -->
                <div class="number-pad">
                    <button class="num-btn" onclick="numPadInput('1')">1</button>
                    <button class="num-btn" onclick="numPadInput('2')">2</button>
                    <button class="num-btn" onclick="numPadInput('3')">3</button>
                    <button class="num-btn" onclick="numPadInput('4')">4</button>
                    <button class="num-btn" onclick="numPadInput('5')">5</button>
                    <button class="num-btn" onclick="numPadInput('6')">6</button>
                    <button class="num-btn" onclick="numPadInput('7')">7</button>
                    <button class="num-btn" onclick="numPadInput('8')">8</button>
                    <button class="num-btn" onclick="numPadInput('9')">9</button>
                    <button class="num-btn clear-btn" onclick="numPadClear()">Clear</button>
                    <button class="num-btn zero-btn" onclick="numPadInput('0')">0</button>
                    <button class="num-btn backspace-btn" onclick="numPadBackspace()">‚å´</button>
                </div>
                
                <div id="feedback" style="margin-top: 20px; font-size: 24px; font-weight: bold; min-height: 30px;"></div>
                <div id="answer-time" class="answer-time-display" style="min-height: 25px;"></div>
                <div id="achievement-display" style="min-height: 35px;"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="endSession()">End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div class="results-screen">
            <div class="results-summary">
                <h2>üéâ Session Complete!</h2>
                <div id="mastery-badge"></div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-time">0.0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="questions-remaining">0</div>
                        <div class="stat-label">Questions to Master</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="backToLevelSelect()">Back to Levels</button>
                    <button class="btn" onclick="retryLevel()">Practice Again</button>
                </div>
            </div>
        </div>
        
        <!-- Teacher View -->
        <div class="teacher-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <div id="teacher-info" style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>Class:</strong> <span id="teacher-class-info"></span>
            </div>
            <div id="teacher-stats" class="loading">Loading student data...</div>
        </div>
        
        <!-- Student Detail Screen (for teachers) -->
        <div class="student-detail-screen">
            <span class="back-link" onclick="showTeacherView()">‚Üê Back to Dashboard</span>
            <h2 id="student-detail-name">Student Details</h2>
            <div id="student-detail-content"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD93cqPEEZ-zL2_CjbszQIBXPWLe2wRd8g",
          authDomain: "math-facts-62a94.firebaseapp.com",
          databaseURL: "https://math-facts-62a94-default-rtdb.firebaseio.com",
          projectId: "math-facts-62a94",
          storageBucket: "math-facts-62a94.firebasestorage.app",
          messagingSenderId: "39584139494",
          appId: "1:39584139494:web:52c8004c167d3172dc5327",
          measurementId: "G-5GDFKPWT4Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Global variables
        let currentUser = null;
        let isTeacher = false;
        let currentLevel = null;
        let currentQuestion = 0;
        let questions = [];
        let answers = [];
        let startTime = null;
        let timerInterval = null;
        let studentData = null;
        let incorrectQuestions = {};
        let authInitialized = false;
        let signupType = 'student';
        let countdownInterval = null;
        let isSigningUp = false;
        let allStudentsData = {}; // Store all students for teacher view
        let isProcessingAnswer = false; // Flag to prevent multiple answer submissions
        let firebaseReady = false; // Flag to track if Firebase Auth is initialized
        
        // Show loading status initially
        document.getElementById('login-status').textContent = 'Loading...';
        
        // Number Pad Functions
        function numPadInput(num) {
            if (isProcessingAnswer) return; // Don't allow input while processing
            
            const input = document.getElementById('answer-input');
            input.value += num;
            checkAnswer();
        }
        
        function numPadClear() {
            if (isProcessingAnswer) return;
            
            const input = document.getElementById('answer-input');
            input.value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').style.color = '';
            document.getElementById('answer-time').textContent = '';
            document.getElementById('achievement-display').innerHTML = '';
        }
        
        function numPadBackspace() {
            if (isProcessingAnswer) return;
            
            const input = document.getElementById('answer-input');
            input.value = input.value.slice(0, -1);
            
            // Clear feedback if input is empty
            if (input.value === '') {
                document.getElementById('feedback').textContent = '';
                document.getElementById('feedback').style.color = '';
                document.getElementById('answer-time').textContent = '';
                document.getElementById('achievement-display').innerHTML = '';
            }
        }
        
        // Level definitions - simplified names without grade designations
        const levels = {
            A: {
                name: 'Level A',
                description: 'Addition & Subtraction to 5',
                operations: ['+', '-'],
                maxNumber: 5,
                unlocked: true,
                questionsPerRound: 10
            },
            B: {
                name: 'Level B',
                description: 'Addition & Subtraction to 10',
                operations: ['+', '-'],
                maxNumber: 10,
                unlocked: false,
                questionsPerRound: 13
            },
            C: {
                name: 'Level C',
                description: 'Facts to 18 & Multiplication to 5√ó5',
                operations: ['+', '-', '√ó', '√∑'],
                maxNumber: 18,
                multMax: 5,
                unlocked: false,
                questionsPerRound: 15
            },
            D: {
                name: 'Level D',
                description: 'Add/Sub to 18 & Mult/Div to 9√ó9',
                operations: ['+', '-', '√ó', '√∑'],
                maxNumber: 18,
                multMax: 9,
                unlocked: false,
                questionsPerRound: 17
            },
            E: {
                name: 'Level E',
                description: 'Multiplication & Division to 12√ó12',
                operations: ['√ó', '√∑'],
                maxNumber: 12,
                unlocked: false,
                questionsPerRound: 19
            }
        };
        
        // Tab switching for instructions
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Convert grade to numeric value for comparison
        function gradeToNumber(grade) {
            if (grade === 'K') return 0;
            return parseInt(grade) || 0;
        }
        
        // Determine starting unlocked levels based on grade
        // Grade 2 and below start at Level A
        // Grade 3 and above start at Level D
        function getUnlockedLevelsForGrade(grade) {
            const gradeNum = gradeToNumber(grade);
            const unlocked = { A: true, B: false, C: false, D: false, E: false };
            
            if (gradeNum >= 3) {
                // Grade 3+ starts at Level D
                unlocked.D = true;
            }
            // Grade 2 and below start at Level A (already set)
            
            return unlocked;
        }
        
        // Get the starting level for a grade
        function getStartingLevelForGrade(grade) {
            const gradeNum = gradeToNumber(grade);
            if (gradeNum >= 3) return 'D';
            return 'A';
        }
        
        // Timing thresholds - Updated with new values per level
        function getTimingThresholds(levelKey) {
            switch (levelKey) {
                case 'A':
                    return { MASTERY: 8, ACCOMPLISHED: 18, BASIC: 30 };
                case 'B':
                    return { MASTERY: 8, ACCOMPLISHED: 18, BASIC: 30 };
                case 'C':
                    return { MASTERY: 5, ACCOMPLISHED: 15, BASIC: 25 };
                case 'D':
                    return { MASTERY: 4, ACCOMPLISHED: 10, BASIC: 20 };
                case 'E':
                    return { MASTERY: 3, ACCOMPLISHED: 10, BASIC: 15 };
                default:
                    return { MASTERY: 8, ACCOMPLISHED: 18, BASIC: 30 };
            }
        }
        
        // Generate complete question set for each level
        function generateCompleteQuestionSet(levelKey) {
            const level = levels[levelKey];
            const questionSet = new Set();
            
            if (level.operations.includes('+')) {
                for (let sum = 0; sum <= level.maxNumber; sum++) {
                    for (let num1 = 0; num1 <= sum; num1++) {
                        const num2 = sum - num1;
                        questionSet.add(`${num1}|${num2}|+|${sum}`);
                    }
                }
            }
            
            if (level.operations.includes('-')) {
                for (let num1 = 0; num1 <= level.maxNumber; num1++) {
                    for (let num2 = 0; num2 <= num1; num2++) {
                        const answer = num1 - num2;
                        questionSet.add(`${num1}|${num2}|-|${answer}`);
                    }
                }
            }
            
            if (level.operations.includes('√ó')) {
                const max = level.multMax || level.maxNumber;
                for (let num1 = 1; num1 <= max; num1++) {
                    for (let num2 = 1; num2 <= max; num2++) {
                        const answer = num1 * num2;
                        questionSet.add(`${num1}|${num2}|√ó|${answer}`);
                    }
                }
            }
            
            if (level.operations.includes('√∑')) {
                const max = level.multMax || level.maxNumber;
                for (let num2 = 1; num2 <= max; num2++) {
                    for (let answer = 1; answer <= max; answer++) {
                        const num1 = num2 * answer;
                        questionSet.add(`${num1}|${num2}|√∑|${answer}`);
                    }
                }
            }
            
            return Array.from(questionSet);
        }
        
        // Enable login buttons when Firebase is ready
        function enableLoginButtons() {
            document.getElementById('student-login-btn').disabled = false;
            document.getElementById('teacher-login-btn').disabled = false;
            document.getElementById('student-signup-btn').disabled = false;
            document.getElementById('teacher-signup-btn').disabled = false;
            document.getElementById('login-status').textContent = '';
        }
        
        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            // Firebase Auth is now ready
            firebaseReady = true;
            enableLoginButtons();
            
            if (isSigningUp) return;
            
            if (user && !authInitialized) {
                authInitialized = true;
                currentUser = user;
                await loadUserData();
                
                const snapshot = await database.ref('users/' + currentUser.uid + '/isTeacher').once('value');
                isTeacher = snapshot.val() === true;
                
                if (isTeacher) {
                    showTeacherView();
                } else {
                    showLevelSelect();
                }
            } else if (!user) {
                authInitialized = false;
                showScreen('login-screen');
            }
        });
        
        function showSignupScreen(type) {
            signupType = type;
            document.getElementById('signup-error').innerHTML = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('signup-name').value = '';
            
            if (type === 'teacher') {
                document.getElementById('signup-title').textContent = 'üë©‚Äçüè´ Teacher Sign Up';
                document.getElementById('teacher-grade-group').style.display = 'block';
                document.getElementById('student-teacher-group').style.display = 'none';
            } else {
                document.getElementById('signup-title').textContent = 'üë®‚Äçüéì Student Sign Up';
                document.getElementById('teacher-grade-group').style.display = 'none';
                document.getElementById('student-teacher-group').style.display = 'block';
            }
            
            showScreen('signup-screen');
        }
        
        function backToLogin() {
            showScreen('login-screen');
        }
        
        async function completeSignup() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value.trim();
            const errorDiv = document.getElementById('signup-error');
            
            if (!email || !password || !name) {
                errorDiv.innerHTML = '<div class="error-message">Please fill in all required fields</div>';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.innerHTML = '<div class="error-message">Password must be at least 6 characters</div>';
                return;
            }
            
            // Check if Firebase is ready
            if (!firebaseReady) {
                errorDiv.innerHTML = '<div class="error-message">Please wait a moment for the system to initialize and try again...</div>';
                return;
            }
            
            isSigningUp = true;
            
            try {
                if (signupType === 'teacher') {
                    const grade = document.getElementById('teacher-grade').value;
                    if (!grade) {
                        errorDiv.innerHTML = '<div class="error-message">Please select your class grade level</div>';
                        isSigningUp = false;
                        return;
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await database.ref('users/' + user.uid).set({
                        email: user.email.toLowerCase(),
                        name: name,
                        isTeacher: true,
                        classGrade: grade,
                        createdAt: new Date().toISOString()
                    });
                    
                    await auth.signOut();
                    isSigningUp = false;
                    
                    errorDiv.innerHTML = '<div class="success-message">Teacher account created successfully! You can now login.</div>';
                    
                } else {
                    const teacherEmail = document.getElementById('student-teacher-email').value.trim().toLowerCase();
                    
                    if (!teacherEmail) {
                        errorDiv.innerHTML = '<div class="error-message">Please enter your teacher\'s email</div>';
                        isSigningUp = false;
                        return;
                    }
                    
                    const teacherSnapshot = await database.ref('users')
                        .orderByChild('email')
                        .equalTo(teacherEmail)
                        .once('value');
                    
                    const teacherData = teacherSnapshot.val();
                    
                    if (!teacherData) {
                        errorDiv.innerHTML = '<div class="error-message">No teacher found with that email address. Please check the email and try again.</div>';
                        isSigningUp = false;
                        return;
                    }
                    
                    let teacherRecord = null;
                    for (let key in teacherData) {
                        if (teacherData[key].isTeacher) {
                            teacherRecord = teacherData[key];
                            break;
                        }
                    }
                    
                    if (!teacherRecord || !teacherRecord.isTeacher) {
                        errorDiv.innerHTML = '<div class="error-message">That email is not registered as a teacher account. Please check the email and try again.</div>';
                        isSigningUp = false;
                        return;
                    }
                    
                    const studentGrade = teacherRecord.classGrade;
                    
                    if (!studentGrade) {
                        errorDiv.innerHTML = '<div class="error-message">The teacher account does not have a grade level set. Please contact your teacher.</div>';
                        isSigningUp = false;
                        return;
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    const unlockedLevels = getUnlockedLevelsForGrade(studentGrade);
                    
                    const levelData = {};
                    for (let levelKey in levels) {
                        const completeSet = generateCompleteQuestionSet(levelKey);
                        levelData[levelKey] = {
                            unlocked: unlockedLevels[levelKey],
                            mastery: null,
                            attempts: [],
                            masteredQuestions: {},
                            completeQuestionSet: completeSet
                        };
                    }
                    
                    await database.ref('users/' + user.uid).set({
                        email: user.email.toLowerCase(),
                        name: name,
                        isTeacher: false,
                        grade: studentGrade,
                        teacherEmail: teacherEmail,
                        createdAt: new Date().toISOString(),
                        levels: levelData
                    });
                    
                    await auth.signOut();
                    isSigningUp = false;
                    
                    const gradeLabel = studentGrade === 'K' ? 'Kindergarten' : `Grade ${studentGrade}`;
                    const startLevel = getStartingLevelForGrade(studentGrade);
                    errorDiv.innerHTML = `<div class="success-message">Student account created successfully! You've been added to your teacher's ${gradeLabel} class and will start at ${levels[startLevel].name}. You can now login.</div>`;
                }
                
            } catch (error) {
                isSigningUp = false;
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        
        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            // Check if Firebase is ready
            if (!firebaseReady) {
                errorDiv.innerHTML = '<div class="error-message">Please wait a moment for the system to initialize and try again...</div>';
                return;
            }
            
            try {
                document.getElementById('student-login-btn').disabled = true;
                await auth.signInWithEmailAndPassword(email, password);
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('student-login-btn').disabled = false;
            }
        }
        
        async function teacherLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            // Check if Firebase is ready
            if (!firebaseReady) {
                errorDiv.innerHTML = '<div class="error-message">Please wait a moment for the system to initialize and try again...</div>';
                return;
            }
            
            try {
                document.getElementById('teacher-login-btn').disabled = true;
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                const snapshot = await database.ref('users/' + currentUser.uid + '/isTeacher').once('value');
                isTeacher = snapshot.val() === true;
                
                if (!isTeacher) {
                    await auth.signOut();
                    currentUser = null;
                    errorDiv.innerHTML = '<div class="error-message">This account is not a teacher account. Please use "Student Login" or sign up as a teacher.</div>';
                    document.getElementById('teacher-login-btn').disabled = false;
                    return;
                }
                
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('teacher-login-btn').disabled = false;
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            const snapshot = await database.ref('users/' + currentUser.uid).once('value');
            studentData = snapshot.val();
            
            if (!studentData || (!studentData.levels && !studentData.isTeacher)) {
                const levelData = {};
                for (let levelKey in levels) {
                    const completeSet = generateCompleteQuestionSet(levelKey);
                    levelData[levelKey] = {
                        unlocked: levelKey === 'A',
                        mastery: null,
                        attempts: [],
                        masteredQuestions: {},
                        completeQuestionSet: completeSet
                    };
                }
                
                studentData = {
                    email: currentUser.email,
                    isTeacher: false,
                    levels: levelData
                };
                await database.ref('users/' + currentUser.uid).set(studentData);
            }
            
            if (studentData.levels) {
                for (let levelKey in studentData.levels) {
                    if (!studentData.levels[levelKey].masteredQuestions) {
                        studentData.levels[levelKey].masteredQuestions = {};
                    }
                    if (!studentData.levels[levelKey].completeQuestionSet) {
                        studentData.levels[levelKey].completeQuestionSet = generateCompleteQuestionSet(levelKey);
                        await database.ref('users/' + currentUser.uid + '/levels/' + levelKey + '/completeQuestionSet')
                            .set(studentData.levels[levelKey].completeQuestionSet);
                    }
                }
            }
        }
        
        async function logout() {
            await auth.signOut();
            currentUser = null;
            isTeacher = false;
            studentData = null;
            authInitialized = false;
            allStudentsData = {};
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('student-login-btn').disabled = false;
            document.getElementById('teacher-login-btn').disabled = false;
            showScreen('login-screen');
        }
        
        function showScreen(screenClass) {
            document.querySelectorAll('.login-screen, .level-select, .question-screen, .results-screen, .teacher-view, .signup-screen, .countdown-screen, .student-detail-screen').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('.' + screenClass).classList.add('active');
        }
        
        // Count questions mastered at each speed tier
        function countQuestionsAtTier(masteredQuestions, tier) {
            let count = 0;
            for (let key in masteredQuestions) {
                const questionTier = masteredQuestions[key];
                if (tier === 'BASIC') {
                    // BASIC counts anything mastered at BASIC, ACCOMPLISHED, or MASTERY
                    if (questionTier === 'BASIC' || questionTier === 'ACCOMPLISHED' || questionTier === 'MASTERY' || questionTier === true) {
                        count++;
                    }
                } else if (tier === 'ACCOMPLISHED') {
                    // ACCOMPLISHED counts ACCOMPLISHED or MASTERY
                    if (questionTier === 'ACCOMPLISHED' || questionTier === 'MASTERY') {
                        count++;
                    }
                } else if (tier === 'MASTERY') {
                    // MASTERY counts only MASTERY
                    if (questionTier === 'MASTERY') {
                        count++;
                    }
                }
            }
            return count;
        }
        
        function showLevelSelect() {
            if (!studentData) return;
            
            const displayName = studentData.name || currentUser.email.split('@')[0];
            document.getElementById('student-name').textContent = displayName;
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            
            const studentLevels = studentData.levels;
            
            for (let levelKey in levels) {
                const level = levels[levelKey];
                const studentLevel = studentLevels[levelKey];
                const card = document.createElement('div');
                card.className = 'level-card' + (studentLevel.unlocked ? '' : ' locked');
                
                let masteryText = '';
                if (studentLevel.mastery) {
                    masteryText = `<div style="font-size: 14px; margin-top: 10px;">${studentLevel.mastery}</div>`;
                }
                
                // Count mastered vs total questions
                const totalQuestions = (studentLevel.completeQuestionSet || []).length;
                const masteredQuestions = studentLevel.masteredQuestions || {};
                
                // Count questions at each tier
                const basicCount = countQuestionsAtTier(masteredQuestions, 'BASIC');
                const accomplishedCount = countQuestionsAtTier(masteredQuestions, 'ACCOMPLISHED');
                const masteryCount = countQuestionsAtTier(masteredQuestions, 'MASTERY');
                
                let progressText = '';
                if (totalQuestions > 0) {
                    // Show question counts at each tier in a consistent style - now vertical
                    progressText = `<div class="level-progress-detail">
                        <div class="level-progress-item ${basicCount === totalQuestions ? 'achieved' : ''}">
                            BASIC: ${basicCount}/${totalQuestions}
                        </div>
                        <div class="level-progress-item ${accomplishedCount === totalQuestions ? 'achieved' : ''}">
                            ACCOMPLISHED: ${accomplishedCount}/${totalQuestions}
                        </div>
                        <div class="level-progress-item ${masteryCount === totalQuestions ? 'achieved' : ''}">
                            MASTERY: ${masteryCount}/${totalQuestions}
                        </div>
                    </div>`;
                }
                
                card.innerHTML = `
                    <h3>${level.name}</h3>
                    <p style="font-size: 14px;">${level.description}</p>
                    ${masteryText}
                    ${progressText}
                `;
                
                if (studentLevel.unlocked) {
                    card.onclick = () => startCountdown(levelKey);
                } else {
                    card.innerHTML += `<div style="font-size: 12px; margin-top: 10px;">üîí Achieve MASTERY on previous level</div>`;
                }
                
                grid.appendChild(card);
            }
            
            showScreen('level-select');
        }
        
        function startCountdown(levelKey) {
            currentLevel = levelKey;
            document.getElementById('countdown-level-name').textContent = levels[levelKey].name;
            
            let count = 5;
            document.getElementById('countdown-number').textContent = count;
            
            showScreen('countdown-screen');
            
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('countdown-number').textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startLevel(levelKey);
                }
            }, 1000);
        }
        
        function cancelCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            showLevelSelect();
        }
        
        function startLevel(levelKey) {
            currentLevel = levelKey;
            currentQuestion = 0;
            answers = [];
            incorrectQuestions = {};
            isProcessingAnswer = false;
            questions = generateQuestions(levelKey);
            
            const studentLevel = studentData.levels[levelKey];
            const totalQuestions = (studentLevel.completeQuestionSet || []).length;
            const masteryCount = countQuestionsAtTier(studentLevel.masteredQuestions || {}, 'MASTERY');
            const remaining = totalQuestions - masteryCount;
            
            const displayDiv = document.getElementById('incorrect-count-display');
            if (remaining > 0) {
                displayDiv.innerHTML = `<div class="mastery-progress">üìä Progress: ${masteryCount}/${totalQuestions} questions mastered (${remaining} remaining)</div>`;
            } else {
                displayDiv.innerHTML = `<div class="mastery-progress" style="background: #d4edda; border-color: #28a745;">‚úì All ${totalQuestions} questions mastered! Practice to improve your speed.</div>`;
            }
            
            showScreen('question-screen');
            
            setTimeout(() => {
                showNextQuestion();
            }, 50);
        }
        
        function generateQuestions(levelKey) {
            const level = levels[levelKey];
            const studentLevel = studentData.levels[levelKey];
            const questionSet = [];
            const questionsPerRound = level.questionsPerRound;
            
            const completeSet = studentLevel.completeQuestionSet || [];
            const masteredQuestions = studentLevel.masteredQuestions || {};
            
            // Unmastered = not at MASTERY tier yet
            const unmasteredQuestions = completeSet.filter(q => {
                const tier = masteredQuestions[q];
                return tier !== 'MASTERY';
            });
            
            // Prioritize unmastered questions
            const numUnmastered = Math.min(unmasteredQuestions.length, questionsPerRound);
            const usedQuestions = new Set();
            
            for (let i = 0; i < numUnmastered; i++) {
                let questionKey;
                let attempts = 0;
                do {
                    questionKey = unmasteredQuestions[Math.floor(Math.random() * unmasteredQuestions.length)];
                    attempts++;
                } while (usedQuestions.has(questionKey) && attempts < 100);
                
                usedQuestions.add(questionKey);
                const parts = questionKey.split('|');
                questionSet.push({
                    num1: parseInt(parts[0]),
                    num2: parseInt(parts[1]),
                    op: parts[2],
                    answer: parseInt(parts[3]),
                    isUnmastered: true,
                    key: questionKey
                });
            }
            
            // Fill remaining with random questions
            for (let i = numUnmastered; i < questionsPerRound; i++) {
                const q = generateSingleQuestion(level);
                q.key = `${q.num1}|${q.num2}|${q.op}|${q.answer}`;
                questionSet.push(q);
            }
            
            return questionSet.sort(() => Math.random() - 0.5);
        }
        
        function generateSingleQuestion(level) {
            const op = level.operations[Math.floor(Math.random() * level.operations.length)];
            let num1, num2, answer;
            
            if (op === '+') {
                answer = Math.floor(Math.random() * (level.maxNumber + 1));
                num1 = Math.floor(Math.random() * (answer + 1));
                num2 = answer - num1;
            } else if (op === '-') {
                num1 = Math.floor(Math.random() * (level.maxNumber + 1));
                num2 = Math.floor(Math.random() * (num1 + 1));
                answer = num1 - num2;
            } else if (op === '√ó') {
                const max = level.multMax || level.maxNumber;
                num1 = Math.floor(Math.random() * max) + 1;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = num1 * num2;
            } else if (op === '√∑') {
                const max = level.multMax || level.maxNumber;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = Math.floor(Math.random() * max) + 1;
                num1 = num2 * answer;
            }
            
            return { num1, num2, op, answer, isUnmastered: false };
        }
        
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }
            
            isProcessingAnswer = false; // Reset flag for new question
            
            const q = questions[currentQuestion];
            document.getElementById('question-text').textContent = `${q.num1} ${q.op} ${q.num2} = ?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer-time').textContent = '';
            document.getElementById('achievement-display').innerHTML = '';
            
            // Hide timer
            document.getElementById('timer').classList.add('timer-hidden');
            
            const progress = ((currentQuestion) / questions.length) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            // Keep timer running internally but hidden
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer').textContent = `Time: ${elapsed.toFixed(1)}s`;
            }, 100);
            
            setTimeout(() => {
                const answerInput = document.getElementById('answer-input');
                answerInput.focus();
            }, 100);
        }
        
        // Determine which achievement tier a time qualifies for
        function getAchievementTier(timeTaken, levelKey) {
            const timings = getTimingThresholds(levelKey);
            if (timeTaken <= timings.MASTERY) {
                return 'MASTERY';
            } else if (timeTaken <= timings.ACCOMPLISHED) {
                return 'ACCOMPLISHED';
            } else if (timeTaken <= timings.BASIC) {
                return 'BASIC';
            }
            return null;
        }
        
        function checkAnswer() {
            if (isProcessingAnswer) return; // Prevent multiple submissions
            
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            const q = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            const answerTimeDiv = document.getElementById('answer-time');
            const achievementDiv = document.getElementById('achievement-display');
            const timings = getTimingThresholds(currentLevel);
            
            if (document.getElementById('answer-input').value === '') {
                feedback.textContent = '';
                feedback.style.color = '';
                answerTimeDiv.textContent = '';
                achievementDiv.innerHTML = '';
                return;
            }
            
            if (userAnswer === q.answer) {
                isProcessingAnswer = true; // Lock input
                clearInterval(timerInterval);
                const timeTaken = (Date.now() - startTime) / 1000;
                
                // Always show correct for correct answers
                feedback.textContent = '‚úì Correct!';
                feedback.style.color = '#28a745';
                answerTimeDiv.textContent = `‚è±Ô∏è ${timeTaken.toFixed(1)}s`;
                
                // Determine achievement tier
                const tier = getAchievementTier(timeTaken, currentLevel);
                
                if (tier === 'MASTERY') {
                    achievementDiv.innerHTML = `<span class="achievement-indicator achievement-mastery">‚≠ê MASTERY (under ${timings.MASTERY}s)</span>`;
                } else if (tier === 'ACCOMPLISHED') {
                    achievementDiv.innerHTML = `<span class="achievement-indicator achievement-accomplished">üéØ ACCOMPLISHED (under ${timings.ACCOMPLISHED}s)</span>`;
                } else if (tier === 'BASIC') {
                    achievementDiv.innerHTML = `<span class="achievement-indicator achievement-basic">‚úîÔ∏è BASIC (under ${timings.BASIC}s)</span>`;
                } else {
                    // Correct but no achievement tier - too slow
                    achievementDiv.innerHTML = `<span style="font-size: 12px; color: #666;">Need under ${timings.BASIC}s to earn progress</span>`;
                }
                
                answers.push({
                    question: q,
                    userAnswer: userAnswer,
                    correct: true,
                    tier: tier, // Store the tier achieved (or null if too slow)
                    time: timeTaken
                });
                
                setTimeout(() => {
                    currentQuestion++;
                    showNextQuestion();
                }, 1200);
                
            } else {
                const answerStr = userAnswer.toString();
                const correctStr = q.answer.toString();
                
                if (answerStr.length >= correctStr.length && userAnswer !== q.answer) {
                    isProcessingAnswer = true; // Lock input
                    clearInterval(timerInterval);
                    const timeTaken = (Date.now() - startTime) / 1000;
                    
                    feedback.innerHTML = `‚úó Incorrect. The answer is <strong>${q.answer}</strong>`;
                    feedback.style.color = '#dc3545';
                    answerTimeDiv.textContent = `‚è±Ô∏è ${timeTaken.toFixed(1)}s`;
                    achievementDiv.innerHTML = '';
                    
                    answers.push({
                        question: q,
                        userAnswer: userAnswer,
                        correct: false,
                        tier: null,
                        time: timeTaken
                    });
                    
                    // Changed from 2000ms to 5000ms (added 3 seconds)
                    setTimeout(() => {
                        currentQuestion++;
                        showNextQuestion();
                    }, 5000);
                }
            }
        }
        
        async function showResults() {
            clearInterval(timerInterval);
            
            const correctCount = answers.filter(a => a.correct).length;
            const totalTime = answers.reduce((sum, a) => sum + a.time, 0);
            const avgTime = totalTime / answers.length;
            const accuracy = (correctCount / answers.length) * 100;
            
            const levelRef = database.ref('users/' + currentUser.uid + '/levels/' + currentLevel);
            const masteredQuestions = studentData.levels[currentLevel].masteredQuestions || {};
            const timings = getTimingThresholds(currentLevel);
            
            // Update mastered questions with tier information
            // Only questions answered correctly AND within time thresholds get upgraded
            for (let answer of answers) {
                const key = answer.question.key || `${answer.question.num1}|${answer.question.num2}|${answer.question.op}|${answer.question.answer}`;
                
                if (answer.correct && answer.tier) {
                    // Only upgrade tier, never downgrade
                    const currentTier = masteredQuestions[key];
                    const tierOrder = { 'BASIC': 1, 'ACCOMPLISHED': 2, 'MASTERY': 3 };
                    
                    if (!currentTier || currentTier === true || tierOrder[answer.tier] > (tierOrder[currentTier] || 0)) {
                        masteredQuestions[key] = answer.tier;
                    }
                }
                // Questions answered incorrectly or too slowly (no tier) do NOT get added to mastered
            }
            
            await levelRef.child('masteredQuestions').set(masteredQuestions);
            studentData.levels[currentLevel].masteredQuestions = masteredQuestions;
            
            const totalQuestions = (studentData.levels[currentLevel].completeQuestionSet || []).length;
            const masteryCount = countQuestionsAtTier(masteredQuestions, 'MASTERY');
            const remainingQuestions = totalQuestions - masteryCount;
            const allQuestionsMastered = remainingQuestions === 0;
            
            let mastery = null;
            if (accuracy >= 80 && allQuestionsMastered) {
                if (avgTime <= timings.MASTERY) {
                    mastery = 'MASTERY';
                } else if (avgTime <= timings.ACCOMPLISHED) {
                    mastery = 'ACCOMPLISHED';
                } else if (avgTime <= timings.BASIC) {
                    mastery = 'BASIC';
                }
            }
            
            const attemptData = {
                date: new Date().toISOString(),
                correctCount: correctCount,
                totalQuestions: answers.length,
                avgTime: avgTime,
                accuracy: accuracy,
                mastery: mastery,
                masteredCount: masteryCount,
                totalLevelQuestions: totalQuestions,
                remainingQuestions: remainingQuestions,
                answers: answers.map(a => ({
                    question: `${a.question.num1} ${a.question.op} ${a.question.num2}`,
                    correctAnswer: a.question.answer,
                    userAnswer: a.userAnswer,
                    correct: a.correct,
                    tier: a.tier || null,
                    time: a.time
                }))
            };
            
            await levelRef.child('attempts').push(attemptData);
            
            if (mastery) {
                const currentMastery = studentData.levels[currentLevel].mastery;
                if (!currentMastery || 
                    (mastery === 'MASTERY') ||
                    (mastery === 'ACCOMPLISHED' && currentMastery === 'BASIC')) {
                    await levelRef.child('mastery').set(mastery);
                    studentData.levels[currentLevel].mastery = mastery;
                }
            }
            
            // Unlock next level ONLY if MASTERY achieved
            if (mastery === 'MASTERY') {
                const levelKeys = Object.keys(levels);
                const currentIndex = levelKeys.indexOf(currentLevel);
                if (currentIndex < levelKeys.length - 1) {
                    const nextLevel = levelKeys[currentIndex + 1];
                    await database.ref('users/' + currentUser.uid + '/levels/' + nextLevel + '/unlocked').set(true);
                    studentData.levels[nextLevel].unlocked = true;
                }
            }
            
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('avg-time').textContent = avgTime.toFixed(1) + 's';
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + '%';
            document.getElementById('questions-remaining').textContent = remainingQuestions;
            
            const badgeDiv = document.getElementById('mastery-badge');
            if (mastery) {
                let nextLevelMsg = '';
                if (mastery === 'MASTERY') {
                    const levelKeys = Object.keys(levels);
                    const currentIndex = levelKeys.indexOf(currentLevel);
                    if (currentIndex < levelKeys.length - 1) {
                        nextLevelMsg = '<p style="color: #28a745; margin-top: 10px;">üéâ Next level unlocked!</p>';
                    }
                }
                badgeDiv.innerHTML = `<div class="mastery-badge mastery-${mastery.toLowerCase()}">${mastery}</div>${nextLevelMsg}`;
            } else if (!allQuestionsMastered) {
                badgeDiv.innerHTML = `<p style="color: #666;">You have ${remainingQuestions} of ${totalQuestions} questions left to master. Keep practicing!</p>`;
            } else if (accuracy < 80) {
                badgeDiv.innerHTML = '<p style="color: #666;">You need 80% accuracy to achieve mastery. Keep practicing!</p>';
            } else {
                badgeDiv.innerHTML = `<p style="color: #666;">Work on your speed! Try to average under ${timings.BASIC}s to achieve mastery.</p>`;
            }
            
            showScreen('results-screen');
        }
        
        function endSession() {
            if (confirm('Are you sure you want to end this session? Your progress will not be saved.')) {
                clearInterval(timerInterval);
                backToLevelSelect();
            }
        }
        
        function backToLevelSelect() {
            showLevelSelect();
        }
        
        function retryLevel() {
            startCountdown(currentLevel);
        }
        
        function getGradeLabel(grade) {
            if (grade === 'K') return 'Kindergarten';
            return `Grade ${grade}`;
        }
        
        async function showTeacherView() {
            const statsDiv = document.getElementById('teacher-stats');
            statsDiv.innerHTML = '<div class="loading">Loading student data...</div>';
            
            const teacherData = studentData;
            const teacherEmail = (teacherData.email || currentUser.email).toLowerCase();
            document.getElementById('teacher-class-info').textContent = 
                `${getGradeLabel(teacherData.classGrade)} (${teacherEmail})`;
            
            showScreen('teacher-view');
            
            try {
                const snapshot = await database.ref('users')
                    .orderByChild('teacherEmail')
                    .equalTo(teacherEmail)
                    .once('value');
                const students = snapshot.val();
                
                let html = '<h3>My Students</h3>';
                
                if (!students || Object.keys(students).length === 0) {
                    html += `<div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 15px;">
                        <p style="color: #1565c0; margin-bottom: 15px;"><strong>üëã Welcome to your dashboard!</strong></p>
                        <p style="color: #666; margin-bottom: 10px;">No students have joined your class yet.</p>
                        <p style="color: #666;">Share your email (<strong>${teacherEmail}</strong>) with students so they can sign up and join your class.</p>
                    </div>`;
                } else {
                    allStudentsData = {};
                    let studentCount = 0;
                    
                    for (let userId in students) {
                        const user = students[userId];
                        if (user.isTeacher) continue;
                        
                        studentCount++;
                        allStudentsData[userId] = user;
                        
                        html += `<div class="student-card">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4>${user.name || user.email || 'Unknown Student'}</h4>
                                    <small style="color: #666;">${user.email}</small>
                                </div>
                                <button class="btn btn-small" onclick="showStudentDetail('${userId}')">View Details</button>
                            </div>`;
                        
                        if (user.levels) {
                            for (let levelKey in user.levels) {
                                const level = user.levels[levelKey];
                                const levelInfo = levels[levelKey];
                                
                                if (level.attempts && typeof level.attempts === 'object') {
                                    const attemptsArray = Object.values(level.attempts);
                                    if (attemptsArray.length > 0) {
                                        const lastAttempt = attemptsArray[attemptsArray.length - 1];
                                        const totalQuestions = (level.completeQuestionSet || []).length;
                                        const masteryCount = countQuestionsAtTier(level.masteredQuestions || {}, 'MASTERY');
                                        
                                        html += `
                                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                                <strong>${levelInfo.name}</strong>: 
                                                ${level.mastery ? `<span class="mastery-badge mastery-${level.mastery.toLowerCase()}" style="font-size: 12px; padding: 3px 10px;">${level.mastery}</span>` : 'In Progress'}
                                                <br>
                                                <small>Progress: ${masteryCount}/${totalQuestions} questions mastered</small>
                                                <br>
                                                <small>Last: ${lastAttempt.correctCount}/${lastAttempt.totalQuestions || lastAttempt.answers?.length || '?'} correct, ${lastAttempt.avgTime.toFixed(1)}s avg, ${attemptsArray.length} attempts</small>
                                            </div>`;
                                    }
                                }
                            }
                        }
                        
                        // Add reset controls
                        html += `<div class="reset-controls">
                            <label style="font-size: 12px; margin: 0;">Reset to level:</label>
                            <select id="reset-level-${userId}" style="width: 120px;">
                                <option value="">Select...</option>
                                ${Object.keys(levels).map(k => `<option value="${k}">${levels[k].name}</option>`).join('')}
                            </select>
                            <button class="btn btn-small btn-danger" onclick="resetStudentLevel('${userId}')">Reset</button>
                        </div>`;
                        
                        html += '</div>';
                    }
                    
                    if (studentCount === 0) {
                        html += `<div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 15px;">
                            <p style="color: #1565c0; margin-bottom: 15px;"><strong>üëã Welcome to your dashboard!</strong></p>
                            <p style="color: #666; margin-bottom: 10px;">No students have joined your class yet.</p>
                            <p style="color: #666;">Share your email (<strong>${teacherEmail}</strong>) with students so they can sign up and join your class.</p>
                        </div>`;
                    }
                }
                
                statsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading students:', error);
                statsDiv.innerHTML = `<div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <p style="color: #1565c0; margin-bottom: 15px;"><strong>üëã Welcome to your dashboard!</strong></p>
                    <p style="color: #666; margin-bottom: 10px;">No students have joined your class yet.</p>
                    <p style="color: #666;">Share your email (<strong>${currentUser.email.toLowerCase()}</strong>) with students so they can sign up and join your class.</p>
                </div>`;
            }
        }
        
        async function resetStudentLevel(userId) {
            const selectEl = document.getElementById(`reset-level-${userId}`);
            const targetLevel = selectEl.value;
            
            if (!targetLevel) {
                alert('Please select a level to reset to.');
                return;
            }
            
            const student = allStudentsData[userId];
            if (!confirm(`Are you sure you want to reset ${student.name || student.email} to ${levels[targetLevel].name}? This will unlock that level and clear mastery status for that level and all levels after it.`)) {
                return;
            }
            
            try {
                const levelKeys = Object.keys(levels);
                const targetIndex = levelKeys.indexOf(targetLevel);
                
                // Build the updates object - update all at once
                const updates = {};
                
                for (let i = targetIndex; i < levelKeys.length; i++) {
                    const levelKey = levelKeys[i];
                    // Reset mastery status and mastered questions for this level and all after
                    updates[`users/${userId}/levels/${levelKey}/mastery`] = null;
                    updates[`users/${userId}/levels/${levelKey}/masteredQuestions`] = {};
                    // Set unlocked status - only unlock target level, lock all after
                    updates[`users/${userId}/levels/${levelKey}/unlocked`] = (i === targetIndex);
                }
                
                // Ensure target level is unlocked
                updates[`users/${userId}/levels/${targetLevel}/unlocked`] = true;
                
                // Apply all updates at once
                await database.ref().update(updates);
                
                alert(`Successfully reset ${student.name || student.email} to ${levels[targetLevel].name}`);
                showTeacherView(); // Refresh the view
            } catch (error) {
                console.error('Error resetting student level:', error);
                alert('Error resetting student level: ' + error.message + '\n\nPlease check that your Firebase security rules allow teachers to modify their students\' data. See the console for details.');
            }
        }
        
        function showStudentDetail(userId) {
            const student = allStudentsData[userId];
            if (!student) return;
            
            document.getElementById('student-detail-name').textContent = student.name || student.email || 'Student Details';
            
            let html = `<p style="color: #666; margin-bottom: 20px;">${student.email}</p>`;
            
            if (student.levels) {
                for (let levelKey in student.levels) {
                    const level = student.levels[levelKey];
                    const levelInfo = levels[levelKey];
                    const totalQuestions = (level.completeQuestionSet || []).length;
                    const masteryCount = countQuestionsAtTier(level.masteredQuestions || {}, 'MASTERY');
                    
                    html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">${levelInfo.name} 
                            ${level.mastery ? `<span class="mastery-badge mastery-${level.mastery.toLowerCase()}" style="font-size: 12px; padding: 3px 10px;">${level.mastery}</span>` : ''}
                            ${level.unlocked ? '' : '<span style="color: #999; font-size: 12px;">üîí Locked</span>'}
                        </h4>
                        <p style="color: #666; font-size: 14px;">Progress: ${masteryCount}/${totalQuestions} questions mastered</p>`;
                    
                    if (level.attempts && typeof level.attempts === 'object') {
                        const attemptsArray = Object.values(level.attempts);
                        if (attemptsArray.length > 0) {
                            html += `<div class="attempt-history" style="margin-top: 15px;">
                                <h5 style="margin-bottom: 10px;">Quiz Attempts (${attemptsArray.length} total)</h5>`;
                            
                            // Show attempts in reverse chronological order
                            const sortedAttempts = [...attemptsArray].reverse();
                            
                            for (let attempt of sortedAttempts) {
                                const date = new Date(attempt.date);
                                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                let badgeClass = '';
                                if (attempt.mastery === 'MASTERY') badgeClass = 'mastery-achieved';
                                else if (attempt.mastery === 'ACCOMPLISHED') badgeClass = 'accomplished-achieved';
                                else if (attempt.mastery === 'BASIC') badgeClass = 'basic-achieved';
                                
                                html += `<div class="attempt-item ${badgeClass}">
                                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                        <div>
                                            <strong>${dateStr}</strong>
                                            ${attempt.mastery ? `<span class="mastery-badge mastery-${attempt.mastery.toLowerCase()}" style="font-size: 10px; padding: 2px 8px; margin-left: 8px;">${attempt.mastery}</span>` : ''}
                                        </div>
                                        <div style="font-size: 14px;">
                                            <span style="color: #28a745;">${attempt.correctCount}/${attempt.totalQuestions || attempt.answers?.length || '?'}</span> correct |
                                            <span style="color: #667eea;">${attempt.avgTime.toFixed(1)}s</span> avg |
                                            <span style="color: ${attempt.accuracy >= 80 ? '#28a745' : '#dc3545'};">${attempt.accuracy.toFixed(0)}%</span>
                                        </div>
                                    </div>`;
                                
                                if (attempt.answers && attempt.answers.length > 0) {
                                    html += `<div class="attempt-questions">`;
                                    for (let ans of attempt.answers) {
                                        // Updated to show tier instead of tooSlow
                                        const tierLabel = ans.tier ? ` (${ans.tier})` : (ans.tooSlow ? ' (slow)' : '');
                                        html += `<span class="attempt-question ${ans.correct ? 'correct' : 'incorrect'}" title="${ans.question} = ${ans.correctAnswer} (answered: ${ans.userAnswer}) - ${ans.time.toFixed(1)}s${tierLabel}">
                                            ${ans.question} ${ans.correct ? '‚úì' : '‚úó'}${ans.tier ? '' : (ans.correct && !ans.tier ? '‚è±' : '')}
                                        </span>`;
                                    }
                                    html += `</div>`;
                                }
                                
                                html += `</div>`;
                            }
                            
                            html += `</div>`;
                        } else {
                            html += `<p style="color: #999; font-size: 14px; margin-top: 10px;">No attempts yet</p>`;
                        }
                    } else {
                        html += `<p style="color: #999; font-size: 14px; margin-top: 10px;">No attempts yet</p>`;
                    }
                    
                    html += `</div>`;
                }
            }
            
            document.getElementById('student-detail-content').innerHTML = html;
            showScreen('student-detail-screen');
        }
    </script>
</body>
</html>
