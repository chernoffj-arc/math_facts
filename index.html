<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edison Math Facts Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-screen, .level-select, .question-screen, .results-screen, .teacher-view, .signup-screen, .countdown-screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-teacher {
            background: #28a745;
        }
        
        .btn-teacher:hover {
            background: #218838;
        }
        
        input[type="text"], input[type="password"], input[type="number"], input[type="email"], select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        select {
            background: white;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .level-card.locked {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .level-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .question-display {
            text-align: center;
            padding: 40px 20px;
        }
        
        .question-text {
            font-size: 48px;
            color: #333;
            margin: 30px 0;
        }
        
        .timer {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .answer-input {
            font-size: 32px;
            text-align: center;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-summary {
            text-align: center;
            padding: 20px;
        }
        
        .results-summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .mastery-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
        }
        
        .mastery-basic {
            background: #ffc107;
            color: #333;
        }
        
        .mastery-accomplished {
            background: #28a745;
            color: white;
        }
        
        .mastery-mastery {
            background: #007bff;
            color: white;
        }
        
        .teacher-stats {
            margin-top: 20px;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect-count {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .mastery-progress {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .instructions-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions-section ul {
            margin-left: 20px;
            color: #555;
        }
        
        .instructions-section li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .pilot-banner {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .countdown-display {
            text-align: center;
            padding: 60px 20px;
        }
        
        .countdown-number {
            font-size: 120px;
            color: #667eea;
            font-weight: bold;
            animation: pulse 1s ease-in-out infinite;
        }
        
        .countdown-text {
            font-size: 24px;
            color: #666;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .question-text {
                font-size: 36px;
            }
            
            .answer-input {
                font-size: 24px;
            }
            
            .countdown-number {
                font-size: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Edison Math Facts Practice</h1>
        
        <!-- Login Screen -->
        <div class="login-screen active">
            <div class="pilot-banner">
                üöÄ Pilot Program - Currently available for Grade 2 students
            </div>
            
            <h2 style="text-align: center; margin-bottom: 20px;">Welcome!</h2>
            
            <!-- Instructions Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('teachers-tab')">üë©‚Äçüè´ For Teachers</button>
                <button class="tab" onclick="switchTab('parents-tab')">üë®‚Äçüë©‚Äçüëß For Parents & Students</button>
            </div>
            
            <div id="teachers-tab" class="tab-content active">
                <div class="instructions-section">
                    <h3>üë©‚Äçüè´ Teacher Instructions</h3>
                    <ul>
                        <li><strong>Sign up as a teacher</strong> using the "Teacher Sign Up" button below. Select your grade level during registration.</li>
                        <li><strong>Share your email</strong> with students/parents so they can join your class when they sign up.</li>
                        <li><strong>Track student progress</strong> through your Teacher Dashboard, which shows mastery levels and practice statistics for each student in your class.</li>
                        <li><strong>Mastery levels:</strong> Students achieve BASIC, ACCOMPLISHED, or MASTERY based on accuracy (‚â•80%) and speed. Only MASTERY unlocks the next level.</li>
                        <li><strong>Questions per round</strong> vary by level (10-19 questions), with timing thresholds adjusted for kindergarteners.</li>
                    </ul>
                </div>
            </div>
            
            <div id="parents-tab" class="tab-content">
                <div class="instructions-section">
                    <h3>üë®‚Äçüë©‚Äçüëß Parent & Student Instructions</h3>
                    <ul>
                        <li><strong>Sign up with your teacher's email</strong> to join their class. Ask your teacher for their email address.</li>
                        <li><strong>Practice math facts</strong> by selecting a level and answering questions as quickly and accurately as you can.</li>
                        <li><strong>5-second countdown</strong> gives you time to get ready before each practice session starts.</li>
                        <li><strong>Master all questions</strong> in a level with 80%+ accuracy to earn mastery badges.</li>
                        <li><strong>Unlock new levels</strong> by achieving MASTERY status (fast answers + high accuracy + all questions mastered).</li>
                        <li><strong>Grade 2+ students</strong> start with Level B unlocked automatically!</li>
                    </ul>
                </div>
            </div>
            
            <div id="login-error"></div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="login()" id="student-login-btn">Student Login</button>
                <button class="btn btn-secondary" onclick="teacherLogin()" id="teacher-login-btn">Teacher Login</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="showSignupScreen('student')" style="background: #17a2b8;">Student Sign Up</button>
                <button class="btn btn-teacher" onclick="showSignupScreen('teacher')">Teacher Sign Up</button>
            </div>
        </div>
        
        <!-- Signup Screen -->
        <div class="signup-screen">
            <h2 style="text-align: center; margin-bottom: 20px;" id="signup-title">Sign Up</h2>
            <div id="signup-error"></div>
            
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Create a password (min 6 characters)">
            </div>
            
            <div class="form-group">
                <label for="signup-name">Name</label>
                <input type="text" id="signup-name" placeholder="Enter your name">
            </div>
            
            <!-- Teacher-specific field -->
            <div class="form-group" id="teacher-grade-group" style="display: none;">
                <label for="teacher-grade">Your Class Grade Level</label>
                <select id="teacher-grade">
                    <option value="">Select grade level...</option>
                    <option value="K">Kindergarten</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                </select>
            </div>
            
            <!-- Student-specific fields -->
            <div class="form-group" id="student-teacher-group" style="display: none;">
                <label for="student-teacher-email">Teacher's Email</label>
                <input type="email" id="student-teacher-email" placeholder="Enter your teacher's email">
            </div>
            
            <div class="form-group" id="student-grade-group" style="display: none;">
                <label for="student-grade">Your Grade Level</label>
                <select id="student-grade">
                    <option value="">Select your grade...</option>
                    <option value="K">Kindergarten</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                </select>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="completeSignup()" id="signup-btn">Create Account</button>
                <button class="btn btn-secondary" onclick="backToLogin()">Back to Login</button>
            </div>
        </div>
        
        <!-- Level Select Screen -->
        <div class="level-select">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Welcome, <span id="student-name"></span>!</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <p style="margin-bottom: 20px;">Choose your level:</p>
            <div class="level-grid" id="level-grid"></div>
        </div>
        
        <!-- Countdown Screen -->
        <div class="countdown-screen">
            <div class="countdown-display">
                <div class="countdown-text">Get Ready!</div>
                <div class="countdown-number" id="countdown-number">5</div>
                <div class="countdown-text" id="countdown-level-name"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="cancelCountdown()">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Question Screen -->
        <div class="question-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">Question 1 of 10</div>
            </div>
            <div id="incorrect-count-display"></div>
            <div class="question-display">
                <div class="timer" id="timer">Time: 0.0s</div>
                <div class="question-text" id="question-text">5 + 3 = ?</div>
                <input type="number" class="answer-input" id="answer-input" oninput="checkAnswer()">
                <div id="feedback" style="margin-top: 20px; font-size: 24px; font-weight: bold; min-height: 30px;"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="endSession()">End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div class="results-screen">
            <div class="results-summary">
                <h2>üéâ Session Complete!</h2>
                <div id="mastery-badge"></div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-time">0.0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="questions-remaining">0</div>
                        <div class="stat-label">Questions to Master</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="backToLevelSelect()">Back to Levels</button>
                    <button class="btn" onclick="retryLevel()">Practice Again</button>
                </div>
            </div>
        </div>
        
        <!-- Teacher View -->
        <div class="teacher-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <div id="teacher-info" style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>Class:</strong> <span id="teacher-class-info"></span>
            </div>
            <div id="teacher-stats" class="loading">Loading student data...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD93cqPEEZ-zL2_CjbszQIBXPWLe2wRd8g",
          authDomain: "math-facts-62a94.firebaseapp.com",
          databaseURL: "https://math-facts-62a94-default-rtdb.firebaseio.com",
          projectId: "math-facts-62a94",
          storageBucket: "math-facts-62a94.firebasestorage.app",
          messagingSenderId: "39584139494",
          appId: "1:39584139494:web:52c8004c167d3172dc5327",
          measurementId: "G-5GDFKPWT4Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Global variables
        let currentUser = null;
        let isTeacher = false;
        let currentLevel = null;
        let currentQuestion = 0;
        let questions = [];
        let answers = [];
        let startTime = null;
        let timerInterval = null;
        let studentData = null;
        let incorrectQuestions = {};
        let authInitialized = false;
        let signupType = 'student';
        let countdownInterval = null;
        
        // Level definitions with question counts
        const levels = {
            A: {
                name: 'Level A - Kindergarten',
                description: 'Addition & Subtraction to 5',
                operations: ['+', '-'],
                maxNumber: 5,
                unlocked: true,
                questionsPerRound: 10
            },
            B: {
                name: 'Level B - Grade 1',
                description: 'Addition & Subtraction to 10',
                operations: ['+', '-'],
                maxNumber: 10,
                unlocked: false,
                questionsPerRound: 13
            },
            C: {
                name: 'Level C - Grade 2',
                description: 'Facts to 18 & Multiplication to 5√ó5',
                operations: ['+', '-', '√ó', '√∑'],
                maxNumber: 18,
                multMax: 5,
                unlocked: false,
                questionsPerRound: 15
            },
            D: {
                name: 'Level D - Grade 3',
                description: 'Multiplication & Division to 9√ó9',
                operations: ['√ó', '√∑'],
                maxNumber: 9,
                unlocked: false,
                questionsPerRound: 17
            },
            E: {
                name: 'Level E - Grade 4',
                description: 'Multiplication & Division to 12√ó12',
                operations: ['√ó', '√∑'],
                maxNumber: 12,
                unlocked: false,
                questionsPerRound: 19
            }
        };
        
        // Tab switching for instructions
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Determine starting unlocked levels based on grade
        function getUnlockedLevelsForGrade(grade) {
            const unlocked = { A: true, B: false, C: false, D: false, E: false };
            
            // Grade 2 and up start with Level B unlocked
            if (['2', '3', '4', '5'].includes(grade)) {
                unlocked.B = true;
            }
            // Could extend this for higher grades if needed
            if (['3', '4', '5'].includes(grade)) {
                unlocked.C = true;
            }
            if (['4', '5'].includes(grade)) {
                unlocked.D = true;
            }
            
            return unlocked;
        }
        
        // Timing thresholds - different for Kindergarten vs other grades
        function getTimingThresholds(levelKey) {
            if (levelKey === 'A') {
                return { MASTERY: 4, ACCOMPLISHED: 6, BASIC: 8 };
            } else {
                return { MASTERY: 2, ACCOMPLISHED: 4, BASIC: 6 };
            }
        }
        
        // Generate complete question set for each level
        function generateCompleteQuestionSet(levelKey) {
            const level = levels[levelKey];
            const questionSet = new Set();
            
            if (level.operations.includes('+')) {
                for (let sum = 0; sum <= level.maxNumber; sum++) {
                    for (let num1 = 0; num1 <= sum; num1++) {
                        const num2 = sum - num1;
                        questionSet.add(`${num1}|${num2}|+|${sum}`);
                    }
                }
            }
            
            if (level.operations.includes('-')) {
                for (let num1 = 0; num1 <= level.maxNumber; num1++) {
                    for (let num2 = 0; num2 <= num1; num2++) {
                        const answer = num1 - num2;
                        questionSet.add(`${num1}|${num2}|-|${answer}`);
                    }
                }
            }
            
            if (level.operations.includes('√ó')) {
                const max = level.multMax || level.maxNumber;
                for (let num1 = 1; num1 <= max; num1++) {
                    for (let num2 = 1; num2 <= max; num2++) {
                        const answer = num1 * num2;
                        questionSet.add(`${num1}|${num2}|√ó|${answer}`);
                    }
                }
            }
            
            if (level.operations.includes('√∑')) {
                const max = level.multMax || level.maxNumber;
                for (let num2 = 1; num2 <= max; num2++) {
                    for (let answer = 1; answer <= max; answer++) {
                        const num1 = num2 * answer;
                        questionSet.add(`${num1}|${num2}|√∑|${answer}`);
                    }
                }
            }
            
            return Array.from(questionSet);
        }
        
        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user && !authInitialized) {
                authInitialized = true;
                currentUser = user;
                await loadUserData();
                
                // Check if user is a teacher
                const snapshot = await database.ref('users/' + currentUser.uid + '/isTeacher').once('value');
                isTeacher = snapshot.val() === true;
                
                if (isTeacher) {
                    showTeacherView();
                } else {
                    showLevelSelect();
                }
            } else if (!user) {
                authInitialized = false;
                showScreen('login-screen');
            }
        });
        
        function showSignupScreen(type) {
            signupType = type;
            document.getElementById('signup-error').innerHTML = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('signup-name').value = '';
            
            if (type === 'teacher') {
                document.getElementById('signup-title').textContent = 'üë©‚Äçüè´ Teacher Sign Up';
                document.getElementById('teacher-grade-group').style.display = 'block';
                document.getElementById('student-teacher-group').style.display = 'none';
                document.getElementById('student-grade-group').style.display = 'none';
            } else {
                document.getElementById('signup-title').textContent = 'üë®‚Äçüéì Student Sign Up';
                document.getElementById('teacher-grade-group').style.display = 'none';
                document.getElementById('student-teacher-group').style.display = 'block';
                document.getElementById('student-grade-group').style.display = 'block';
            }
            
            showScreen('signup-screen');
        }
        
        function backToLogin() {
            showScreen('login-screen');
        }
        
        async function completeSignup() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value.trim();
            const errorDiv = document.getElementById('signup-error');
            
            if (!email || !password || !name) {
                errorDiv.innerHTML = '<div class="error-message">Please fill in all required fields</div>';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.innerHTML = '<div class="error-message">Password must be at least 6 characters</div>';
                return;
            }
            
            try {
                if (signupType === 'teacher') {
                    const grade = document.getElementById('teacher-grade').value;
                    if (!grade) {
                        errorDiv.innerHTML = '<div class="error-message">Please select your class grade level</div>';
                        return;
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Create teacher account
                    await database.ref('users/' + user.uid).set({
                        email: user.email,
                        name: name,
                        isTeacher: true,
                        classGrade: grade,
                        createdAt: new Date().toISOString()
                    });
                    
                    // Also index by email for student lookup
                    const emailKey = email.replace(/\./g, ',');
                    await database.ref('teacherEmails/' + emailKey).set({
                        uid: user.uid,
                        grade: grade
                    });
                    
                    errorDiv.innerHTML = '<div class="success-message">Teacher account created successfully! You can now login.</div>';
                    
                } else {
                    // Student signup
                    const teacherEmail = document.getElementById('student-teacher-email').value.trim().toLowerCase();
                    const studentGrade = document.getElementById('student-grade').value;
                    
                    if (!teacherEmail) {
                        errorDiv.innerHTML = '<div class="error-message">Please enter your teacher\'s email</div>';
                        return;
                    }
                    
                    if (!studentGrade) {
                        errorDiv.innerHTML = '<div class="error-message">Please select your grade level</div>';
                        return;
                    }
                    
                    // Verify teacher exists
                    const teacherEmailKey = teacherEmail.replace(/\./g, ',');
                    const teacherSnapshot = await database.ref('teacherEmails/' + teacherEmailKey).once('value');
                    const teacherData = teacherSnapshot.val();
                    
                    if (!teacherData) {
                        errorDiv.innerHTML = '<div class="error-message">Teacher not found. Please check the email address and make sure your teacher has signed up.</div>';
                        return;
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Determine unlocked levels based on grade
                    const unlockedLevels = getUnlockedLevelsForGrade(studentGrade);
                    
                    // Generate complete question sets for all levels
                    const levelData = {};
                    for (let levelKey in levels) {
                        const completeSet = generateCompleteQuestionSet(levelKey);
                        levelData[levelKey] = {
                            unlocked: unlockedLevels[levelKey],
                            mastery: null,
                            attempts: [],
                            masteredQuestions: {},
                            completeQuestionSet: completeSet
                        };
                    }
                    
                    // Initialize student data in database
                    await database.ref('users/' + user.uid).set({
                        email: user.email,
                        name: name,
                        isTeacher: false,
                        grade: studentGrade,
                        teacherEmail: teacherEmail,
                        teacherUid: teacherData.uid,
                        createdAt: new Date().toISOString(),
                        levels: levelData
                    });
                    
                    errorDiv.innerHTML = '<div class="success-message">Student account created successfully! You can now login.</div>';
                }
                
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        
        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            try {
                document.getElementById('student-login-btn').disabled = true;
                await auth.signInWithEmailAndPassword(email, password);
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('student-login-btn').disabled = false;
            }
        }
        
        async function teacherLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">Please enter email and password</div>';
                return;
            }
            
            try {
                document.getElementById('teacher-login-btn').disabled = true;
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Check if user is a teacher
                const snapshot = await database.ref('users/' + currentUser.uid + '/isTeacher').once('value');
                isTeacher = snapshot.val() === true;
                
                if (!isTeacher) {
                    await auth.signOut();
                    currentUser = null;
                    errorDiv.innerHTML = '<div class="error-message">This account is not a teacher account. Please use "Student Login" or sign up as a teacher.</div>';
                    document.getElementById('teacher-login-btn').disabled = false;
                    return;
                }
                
                errorDiv.innerHTML = '';
            } catch (error) {
                errorDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
                document.getElementById('teacher-login-btn').disabled = false;
            }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            
            const snapshot = await database.ref('users/' + currentUser.uid).once('value');
            studentData = snapshot.val();
            
            // Initialize if no data exists (legacy accounts)
            if (!studentData || (!studentData.levels && !studentData.isTeacher)) {
                const levelData = {};
                for (let levelKey in levels) {
                    const completeSet = generateCompleteQuestionSet(levelKey);
                    levelData[levelKey] = {
                        unlocked: levelKey === 'A',
                        mastery: null,
                        attempts: [],
                        masteredQuestions: {},
                        completeQuestionSet: completeSet
                    };
                }
                
                studentData = {
                    email: currentUser.email,
                    isTeacher: false,
                    levels: levelData
                };
                await database.ref('users/' + currentUser.uid).set(studentData);
            }
            
            // Ensure each level has required fields (for students)
            if (studentData.levels) {
                for (let levelKey in studentData.levels) {
                    if (!studentData.levels[levelKey].masteredQuestions) {
                        studentData.levels[levelKey].masteredQuestions = {};
                    }
                    if (!studentData.levels[levelKey].completeQuestionSet) {
                        studentData.levels[levelKey].completeQuestionSet = generateCompleteQuestionSet(levelKey);
                        await database.ref('users/' + currentUser.uid + '/levels/' + levelKey + '/completeQuestionSet')
                            .set(studentData.levels[levelKey].completeQuestionSet);
                    }
                }
            }
        }
        
        async function logout() {
            await auth.signOut();
            currentUser = null;
            isTeacher = false;
            studentData = null;
            authInitialized = false;
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('student-login-btn').disabled = false;
            document.getElementById('teacher-login-btn').disabled = false;
            showScreen('login-screen');
        }
        
        function showScreen(screenClass) {
            document.querySelectorAll('.login-screen, .level-select, .question-screen, .results-screen, .teacher-view, .signup-screen, .countdown-screen').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('.' + screenClass).classList.add('active');
        }
        
        function showLevelSelect() {
            if (!studentData) return;
            
            const displayName = studentData.name || currentUser.email.split('@')[0];
            document.getElementById('student-name').textContent = displayName;
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            
            const studentLevels = studentData.levels;
            
            for (let levelKey in levels) {
                const level = levels[levelKey];
                const studentLevel = studentLevels[levelKey];
                const card = document.createElement('div');
                card.className = 'level-card' + (studentLevel.unlocked ? '' : ' locked');
                
                let masteryText = '';
                if (studentLevel.mastery) {
                    masteryText = `<div style="font-size: 14px; margin-top: 10px;">${studentLevel.mastery}</div>`;
                }
                
                // Count mastered vs total questions
                const totalQuestions = (studentLevel.completeQuestionSet || []).length;
                const masteredCount = Object.keys(studentLevel.masteredQuestions || {}).length;
                const remaining = totalQuestions - masteredCount;
                
                let progressText = '';
                if (totalQuestions > 0) {
                    progressText = `<div style="font-size: 12px; margin-top: 5px; background: rgba(255,255,255,0.3); padding: 5px; border-radius: 5px;">üìä ${masteredCount}/${totalQuestions} mastered</div>`;
                }
                
                card.innerHTML = `
                    <h3>${level.name}</h3>
                    <p style="font-size: 14px;">${level.description}</p>
                    ${masteryText}
                    ${progressText}
                `;
                
                if (studentLevel.unlocked) {
                    card.onclick = () => startCountdown(levelKey);
                } else {
                    card.innerHTML += `<div style="font-size: 12px; margin-top: 10px;">üîí Achieve MASTERY on previous level</div>`;
                }
                
                grid.appendChild(card);
            }
            
            showScreen('level-select');
        }
        
        function startCountdown(levelKey) {
            currentLevel = levelKey;
            document.getElementById('countdown-level-name').textContent = levels[levelKey].name;
            
            let count = 5;
            document.getElementById('countdown-number').textContent = count;
            
            showScreen('countdown-screen');
            
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('countdown-number').textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    startLevel(levelKey);
                }
            }, 1000);
        }
        
        function cancelCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            showLevelSelect();
        }
        
        function startLevel(levelKey) {
            currentLevel = levelKey;
            currentQuestion = 0;
            answers = [];
            incorrectQuestions = {};
            questions = generateQuestions(levelKey);
            
            // Display progress info
            const studentLevel = studentData.levels[levelKey];
            const totalQuestions = (studentLevel.completeQuestionSet || []).length;
            const masteredCount = Object.keys(studentLevel.masteredQuestions || {}).length;
            const remaining = totalQuestions - masteredCount;
            
            const displayDiv = document.getElementById('incorrect-count-display');
            if (remaining > 0) {
                displayDiv.innerHTML = `<div class="mastery-progress">üìä Progress: ${masteredCount}/${totalQuestions} questions mastered (${remaining} remaining)</div>`;
            } else {
                displayDiv.innerHTML = `<div class="mastery-progress" style="background: #d4edda; border-color: #28a745;">‚úì All ${totalQuestions} questions mastered! Practice to improve your speed.</div>`;
            }
            
            showNextQuestion();
            showScreen('question-screen');
        }
        
        function generateQuestions(levelKey) {
            const level = levels[levelKey];
            const studentLevel = studentData.levels[levelKey];
            const questionSet = [];
            const questionsPerRound = level.questionsPerRound;
            
            // Get unmastered questions
            const completeSet = studentLevel.completeQuestionSet || [];
            const masteredQuestions = studentLevel.masteredQuestions || {};
            const unmasteredQuestions = completeSet.filter(q => !masteredQuestions[q]);
            
            // Prioritize unmastered questions
            const numUnmastered = Math.min(unmasteredQuestions.length, questionsPerRound);
            
            for (let i = 0; i < numUnmastered; i++) {
                const questionKey = unmasteredQuestions[Math.floor(Math.random() * unmasteredQuestions.length)];
                const parts = questionKey.split('|');
                questionSet.push({
                    num1: parseInt(parts[0]),
                    num2: parseInt(parts[1]),
                    op: parts[2],
                    answer: parseInt(parts[3]),
                    isUnmastered: true
                });
            }
            
            // Fill remaining with random questions
            for (let i = numUnmastered; i < questionsPerRound; i++) {
                questionSet.push(generateSingleQuestion(level));
            }
            
            // Shuffle questions
            return questionSet.sort(() => Math.random() - 0.5);
        }
        
        function generateSingleQuestion(level) {
            const op = level.operations[Math.floor(Math.random() * level.operations.length)];
            let num1, num2, answer;
            
            if (op === '+') {
                answer = Math.floor(Math.random() * (level.maxNumber + 1));
                num1 = Math.floor(Math.random() * (answer + 1));
                num2 = answer - num1;
            } else if (op === '-') {
                num1 = Math.floor(Math.random() * (level.maxNumber + 1));
                num2 = Math.floor(Math.random() * (num1 + 1));
                answer = num1 - num2;
            } else if (op === '√ó') {
                const max = level.multMax || level.maxNumber;
                num1 = Math.floor(Math.random() * max) + 1;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = num1 * num2;
            } else if (op === '√∑') {
                const max = level.multMax || level.maxNumber;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = Math.floor(Math.random() * max) + 1;
                num1 = num2 * answer;
            }
            
            return { num1, num2, op, answer, isUnmastered: false };
        }
        
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }
            
            const q = questions[currentQuestion];
            document.getElementById('question-text').textContent = `${q.num1} ${q.op} ${q.num2} = ?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer-input').focus();
            
            const progress = ((currentQuestion) / questions.length) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
        }
        
        function updateTimer() {
            const elapsed = (Date.now() - startTime) / 1000;
            document.getElementById('timer').textContent = `Time: ${elapsed.toFixed(1)}s`;
        }
        
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            const q = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            
            if (document.getElementById('answer-input').value === '') {
                feedback.textContent = '';
                feedback.style.color = '';
                return;
            }
            
            if (userAnswer === q.answer) {
                feedback.textContent = '‚úì Correct!';
                feedback.style.color = '#28a745';
                
                clearInterval(timerInterval);
                const timeTaken = (Date.now() - startTime) / 1000;
                
                answers.push({
                    question: q,
                    userAnswer: userAnswer,
                    correct: true,
                    time: timeTaken
                });
                
                setTimeout(() => {
                    currentQuestion++;
                    showNextQuestion();
                }, 500);
            } else {
                const answerStr = userAnswer.toString();
                const correctStr = q.answer.toString();
                
                if (answerStr.length >= correctStr.length && userAnswer !== q.answer) {
                    feedback.innerHTML = `‚úó Incorrect. The answer is <strong>${q.answer}</strong>`;
                    feedback.style.color = '#dc3545';
                    
                    clearInterval(timerInterval);
                    const timeTaken = (Date.now() - startTime) / 1000;
                    
                    answers.push({
                        question: q,
                        userAnswer: userAnswer,
                        correct: false,
                        time: timeTaken
                    });
                    
                    setTimeout(() => {
                        currentQuestion++;
                        showNextQuestion();
                    }, 2000);
                }
            }
        }
        
        async function showResults() {
            clearInterval(timerInterval);
            
            const correctCount = answers.filter(a => a.correct).length;
            const totalTime = answers.reduce((sum, a) => sum + a.time, 0);
            const avgTime = totalTime / answers.length;
            const accuracy = (correctCount / answers.length) * 100;
            
            const levelRef = database.ref('users/' + currentUser.uid + '/levels/' + currentLevel);
            const masteredQuestions = studentData.levels[currentLevel].masteredQuestions || {};
            
            // Update mastered questions
            for (let answer of answers) {
                if (answer.correct) {
                    const key = `${answer.question.num1}|${answer.question.num2}|${answer.question.op}|${answer.question.answer}`;
                    masteredQuestions[key] = true;
                }
            }
            
            await levelRef.child('masteredQuestions').set(masteredQuestions);
            studentData.levels[currentLevel].masteredQuestions = masteredQuestions;
            
            // Calculate progress
            const totalQuestions = (studentData.levels[currentLevel].completeQuestionSet || []).length;
            const masteredCount = Object.keys(masteredQuestions).length;
            const remainingQuestions = totalQuestions - masteredCount;
            const allQuestionsMastered = remainingQuestions === 0;
            
            // Determine mastery level - requires ALL questions mastered
            const timings = getTimingThresholds(currentLevel);
            let mastery = null;
            if (accuracy >= 80 && allQuestionsMastered) {
                if (avgTime <= timings.MASTERY) {
                    mastery = 'MASTERY';
                } else if (avgTime <= timings.ACCOMPLISHED) {
                    mastery = 'ACCOMPLISHED';
                } else if (avgTime <= timings.BASIC) {
                    mastery = 'BASIC';
                }
            }
            
            // Prepare attempt data
            const attemptData = {
                date: new Date().toISOString(),
                correctCount: correctCount,
                avgTime: avgTime,
                accuracy: accuracy,
                mastery: mastery,
                masteredCount: masteredCount,
                totalQuestions: totalQuestions,
                remainingQuestions: remainingQuestions,
                answers: answers.map(a => ({
                    question: `${a.question.num1} ${a.question.op} ${a.question.num2}`,
                    correctAnswer: a.question.answer,
                    userAnswer: a.userAnswer,
                    correct: a.correct,
                    time: a.time
                }))
            };
            
            // Add attempt
            await levelRef.child('attempts').push(attemptData);
            
            // Update mastery level only if achieved and better than current
            if (mastery) {
                const currentMastery = studentData.levels[currentLevel].mastery;
                if (!currentMastery || 
                    (mastery === 'MASTERY') ||
                    (mastery === 'ACCOMPLISHED' && currentMastery === 'BASIC')) {
                    await levelRef.child('mastery').set(mastery);
                    studentData.levels[currentLevel].mastery = mastery;
                }
            }
            
            // Unlock next level ONLY if MASTERY achieved
            if (mastery === 'MASTERY') {
                const levelKeys = Object.keys(levels);
                const currentIndex = levelKeys.indexOf(currentLevel);
                if (currentIndex < levelKeys.length - 1) {
                    const nextLevel = levelKeys[currentIndex + 1];
                    await database.ref('users/' + currentUser.uid + '/levels/' + nextLevel + '/unlocked').set(true);
                    studentData.levels[nextLevel].unlocked = true;
                }
            }
            
            // Display results
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('avg-time').textContent = avgTime.toFixed(1) + 's';
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + '%';
            document.getElementById('questions-remaining').textContent = remainingQuestions;
            
            const badgeDiv = document.getElementById('mastery-badge');
            if (mastery) {
                let nextLevelMsg = '';
                if (mastery === 'MASTERY') {
                    const levelKeys = Object.keys(levels);
                    const currentIndex = levelKeys.indexOf(currentLevel);
                    if (currentIndex < levelKeys.length - 1) {
                        nextLevelMsg = '<p style="color: #28a745; margin-top: 10px;">üéâ Next level unlocked!</p>';
                    }
                }
                badgeDiv.innerHTML = `<div class="mastery-badge mastery-${mastery.toLowerCase()}">${mastery}</div>${nextLevelMsg}`;
            } else if (!allQuestionsMastered) {
                badgeDiv.innerHTML = `<p style="color: #666;">You have ${remainingQuestions} of ${totalQuestions} questions left to master. Keep practicing!</p>`;
            } else if (accuracy < 80) {
                badgeDiv.innerHTML = '<p style="color: #666;">You need 80% accuracy to achieve mastery. Keep practicing!</p>';
            } else {
                const timings = getTimingThresholds(currentLevel);
                badgeDiv.innerHTML = `<p style="color: #666;">Work on your speed! Try to average under ${timings.BASIC}s to achieve mastery.</p>`;
            }
            
            showScreen('results-screen');
        }
        
        function endSession() {
            if (confirm('Are you sure you want to end this session? Your progress will not be saved.')) {
                clearInterval(timerInterval);
                backToLevelSelect();
            }
        }
        
        function backToLevelSelect() {
            showLevelSelect();
        }
        
        function retryLevel() {
            startCountdown(currentLevel);
        }
        
        function getGradeLabel(grade) {
            if (grade === 'K') return 'Kindergarten';
            return `Grade ${grade}`;
        }
        
        async function showTeacherView() {
            const statsDiv = document.getElementById('teacher-stats');
            statsDiv.innerHTML = '<div class="loading">Loading student data...</div>';
            
            // Show teacher info
            const teacherData = studentData;
            document.getElementById('teacher-class-info').textContent = 
                `${getGradeLabel(teacherData.classGrade)} (${teacherData.email})`;
            
            try {
                // Only fetch students assigned to this teacher
                const snapshot = await database.ref('users')
                    .orderByChild('teacherUid')
                    .equalTo(currentUser.uid)
                    .once('value');
                const students = snapshot.val();
                
                let html = '<h3>My Students</h3>';
                
                if (!students) {
                    html += `<p style="color: #666; padding: 20px;">No students have joined your class yet.</p>
                             <p style="color: #666; padding: 0 20px;">Share your email (<strong>${teacherData.email}</strong>) with students so they can sign up and join your class.</p>`;
                } else {
                    let studentCount = 0;
                    for (let userId in students) {
                        const user = students[userId];
                        if (user.isTeacher) continue;
                        
                        studentCount++;
                        html += `<div class="student-card">
                            <h4>${user.name || user.email || 'Unknown Student'}</h4>
                            <small style="color: #666;">${user.email} - ${getGradeLabel(user.grade)}</small>`;
                        
                        if (user.levels) {
                            for (let levelKey in user.levels) {
                                const level = user.levels[levelKey];
                                const levelInfo = levels[levelKey];
                                
                                if (level.attempts && typeof level.attempts === 'object') {
                                    const attemptsArray = Object.values(level.attempts);
                                    if (attemptsArray.length > 0) {
                                        const lastAttempt = attemptsArray[attemptsArray.length - 1];
                                        const totalQuestions = (level.completeQuestionSet || []).length;
                                        const masteredCount = Object.keys(level.masteredQuestions || {}).length;
                                        
                                        html += `
                                            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                                <strong>${levelInfo.name}</strong>: 
                                                ${level.mastery ? `<span class="mastery-badge mastery-${level.mastery.toLowerCase()}" style="font-size: 12px; padding: 3px 10px;">${level.mastery}</span>` : 'In Progress'}
                                                <br>
                                                <small>Progress: ${masteredCount}/${totalQuestions} questions mastered</small>
                                                <br>
                                                <small>Last: ${lastAttempt.correctCount}/${lastAttempt.answers ? lastAttempt.answers.length : '?'} correct, ${lastAttempt.avgTime.toFixed(1)}s avg, ${attemptsArray.length} attempts</small>
                                            </div>`;
                                    }
                                }
                            }
                        }
                        
                        html += '</div>';
                    }
                    
                    if (studentCount === 0) {
                        html += `<p style="color: #666; padding: 20px;">No students have joined your class yet.</p>
                                 <p style="color: #666; padding: 0 20px;">Share your email (<strong>${teacherData.email}</strong>) with students so they can sign up and join your class.</p>`;
                    }
                }
                
                statsDiv.innerHTML = html;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error-message">Error loading student data: ${error.message}</div>`;
            }
            
            showScreen('teacher-view');
        }
    </script>
</body>
</html>
