<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edison Math Facts Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-screen, .level-select, .question-screen, .results-screen, .teacher-view {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .level-card.locked {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .level-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .question-display {
            text-align: center;
            padding: 40px 20px;
        }
        
        .question-text {
            font-size: 48px;
            color: #333;
            margin: 30px 0;
        }
        
        .timer {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .answer-input {
            font-size: 32px;
            text-align: center;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-summary {
            text-align: center;
            padding: 20px;
        }
        
        .results-summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .mastery-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
        }
        
        .mastery-basic {
            background: #ffc107;
            color: #333;
        }
        
        .mastery-accomplished {
            background: #28a745;
            color: white;
        }
        
        .mastery-mastery {
            background: #007bff;
            color: white;
        }
        
        .teacher-stats {
            margin-top: 20px;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .question-text {
                font-size: 36px;
            }
            
            .answer-input {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ“ Edison Math Facts Practice</h1>
        
        <!-- Login Screen -->
        <div class="login-screen active">
            <h2 style="text-align: center; margin-bottom: 20px;">Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="login()">Student Login</button>
                <button class="btn btn-secondary" onclick="teacherLogin()">Teacher Login</button>
            </div>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                Demo: Use any username/password to login
            </p>
        </div>
        
        <!-- Level Select Screen -->
        <div class="level-select">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Welcome, <span id="student-name"></span>!</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <p style="margin-bottom: 20px;">Choose your level:</p>
            <div class="level-grid" id="level-grid"></div>
        </div>
        
        <!-- Question Screen -->
        <div class="question-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">Question 1 of 10</div>
            </div>
            <div class="question-display">
                <div class="timer" id="timer">Time: 0.0s</div>
                <div class="question-text" id="question-text">5 + 3 = ?</div>
                <input type="number" class="answer-input" id="answer-input" oninput="checkAnswer()">
                <div id="feedback" style="margin-top: 20px; font-size: 24px; font-weight: bold; min-height: 30px;"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="endSession()">End Session</button>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div class="results-screen">
            <div class="results-summary">
                <h2>ðŸŽ‰ Session Complete!</h2>
                <div id="mastery-badge"></div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-time">0.0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="backToLevelSelect()">Back to Levels</button>
                    <button class="btn" onclick="retryLevel()">Practice Again</button>
                </div>
            </div>
        </div>
        
        <!-- Teacher View -->
        <div class="teacher-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <div id="teacher-stats"></div>
        </div>
    </div>

    <script>
        // Data Storage (in-memory for session)
        let currentUser = null;
        let isTeacher = false;
        let currentLevel = null;
        let currentQuestion = 0;
        let questions = [];
        let answers = [];
        let startTime = null;
        let timerInterval = null;
        
        // Student progress data
        let studentData = {
            students: {}
        };
        
        // Level definitions
        const levels = {
            A: {
                name: 'Level A - Kindergarten',
                description: 'Addition & Subtraction to 5',
                operations: ['+', '-'],
                maxNumber: 5,
                unlocked: true
            },
            B: {
                name: 'Level B - Grade 1',
                description: 'Addition & Subtraction to 10',
                operations: ['+', '-'],
                maxNumber: 10,
                unlocked: false
            },
            C: {
                name: 'Level C - Grade 2',
                description: 'Facts to 18 & Multiplication to 5Ã—5',
                operations: ['+', '-', 'Ã—', 'Ã·'],
                maxNumber: 18,
                multMax: 5,
                unlocked: false
            },
            D: {
                name: 'Level D - Grade 3',
                description: 'Multiplication & Division to 9Ã—9',
                operations: ['Ã—', 'Ã·'],
                maxNumber: 9,
                unlocked: false
            },
            E: {
                name: 'Level E - Grade 4',
                description: 'Multiplication & Division to 12Ã—12',
                operations: ['Ã—', 'Ã·'],
                maxNumber: 12,
                unlocked: false
            }
        };
        
        // Timing thresholds
        const timings = {
            MASTERY: 4,
            ACCOMPLISHED: 6,
            BASIC: 8
        };
        
        function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            currentUser = username;
            isTeacher = false;
            
            // Initialize student data if not exists
            if (!studentData.students[username]) {
                studentData.students[username] = {
                    levels: {
                        A: { unlocked: true, mastery: null, attempts: [], weakAreas: {} },
                        B: { unlocked: false, mastery: null, attempts: [], weakAreas: {} },
                        C: { unlocked: false, mastery: null, attempts: [], weakAreas: {} },
                        D: { unlocked: false, mastery: null, attempts: [], weakAreas: {} },
                        E: { unlocked: false, mastery: null, attempts: [], weakAreas: {} }
                    }
                };
            }
            
            showLevelSelect();
        }
        
        function teacherLogin() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            currentUser = username;
            isTeacher = true;
            showTeacherView();
        }
        
        function logout() {
            currentUser = null;
            isTeacher = false;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showScreen('login-screen');
        }
        
        function showScreen(screenClass) {
            document.querySelectorAll('.login-screen, .level-select, .question-screen, .results-screen, .teacher-view').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('.' + screenClass).classList.add('active');
        }
        
        function showLevelSelect() {
            document.getElementById('student-name').textContent = currentUser;
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            
            const studentLevels = studentData.students[currentUser].levels;
            
            for (let levelKey in levels) {
                const level = levels[levelKey];
                const studentLevel = studentLevels[levelKey];
                const card = document.createElement('div');
                card.className = 'level-card' + (studentLevel.unlocked ? '' : ' locked');
                
                let masteryText = '';
                if (studentLevel.mastery) {
                    masteryText = `<div style="font-size: 14px; margin-top: 10px;">${studentLevel.mastery}</div>`;
                }
                
                card.innerHTML = `
                    <h3>${level.name}</h3>
                    <p style="font-size: 14px;">${level.description}</p>
                    ${masteryText}
                `;
                
                if (studentLevel.unlocked) {
                    card.onclick = () => startLevel(levelKey);
                }
                
                grid.appendChild(card);
            }
            
            showScreen('level-select');
        }
        
        function startLevel(levelKey) {
            currentLevel = levelKey;
            currentQuestion = 0;
            answers = [];
            questions = generateQuestions(levelKey);
            showNextQuestion();
            showScreen('question-screen');
        }
        
        function generateQuestions(levelKey) {
            const level = levels[levelKey];
            const studentLevel = studentData.students[currentUser].levels[levelKey];
            const questionSet = [];
            
            // 60% new questions, 40% from weak areas
            const weakAreaCount = Math.min(4, Object.keys(studentLevel.weakAreas).length);
            const newQuestionCount = 10 - weakAreaCount;
            
            // Add weak area questions
            const weakQuestions = Object.keys(studentLevel.weakAreas);
            for (let i = 0; i < weakAreaCount && i < weakQuestions.length; i++) {
                const q = weakQuestions[i].split('|');
                questionSet.push({
                    num1: parseInt(q[0]),
                    num2: parseInt(q[1]),
                    op: q[2],
                    answer: parseInt(q[3])
                });
            }
            
            // Generate new questions
            for (let i = 0; i < newQuestionCount; i++) {
                questionSet.push(generateSingleQuestion(level));
            }
            
            // Shuffle questions
            return questionSet.sort(() => Math.random() - 0.5);
        }
        
        function generateSingleQuestion(level) {
            const op = level.operations[Math.floor(Math.random() * level.operations.length)];
            let num1, num2, answer;
            
            if (op === '+') {
                // For addition, ensure the sum doesn't exceed maxNumber
                answer = Math.floor(Math.random() * (level.maxNumber + 1));
                num1 = Math.floor(Math.random() * (answer + 1));
                num2 = answer - num1;
            } else if (op === '-') {
                // For subtraction, num1 should be <= maxNumber
                num1 = Math.floor(Math.random() * (level.maxNumber + 1));
                num2 = Math.floor(Math.random() * (num1 + 1));
                answer = num1 - num2;
            } else if (op === 'Ã—') {
                const max = level.multMax || level.maxNumber;
                num1 = Math.floor(Math.random() * max) + 1;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = num1 * num2;
            } else if (op === 'Ã·') {
                const max = level.multMax || level.maxNumber;
                num2 = Math.floor(Math.random() * max) + 1;
                answer = Math.floor(Math.random() * max) + 1;
                num1 = num2 * answer;
            }
            
            return { num1, num2, op, answer };
        }
        
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }
            
            const q = questions[currentQuestion];
            document.getElementById('question-text').textContent = `${q.num1} ${q.op} ${q.num2} = ?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer-input').focus();
            
            const progress = ((currentQuestion) / questions.length) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
        }
        
        function updateTimer() {
            const elapsed = (Date.now() - startTime) / 1000;
            document.getElementById('timer').textContent = `Time: ${elapsed.toFixed(1)}s`;
        }
        
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            const q = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            
            // Clear feedback if input is empty
            if (document.getElementById('answer-input').value === '') {
                feedback.textContent = '';
                feedback.style.color = '';
                return;
            }
            
            // Check if answer is correct
            if (userAnswer === q.answer) {
                feedback.textContent = 'âœ“ Correct!';
                feedback.style.color = '#28a745';
                
                // Record the answer and move to next question after a brief delay
                clearInterval(timerInterval);
                const timeTaken = (Date.now() - startTime) / 1000;
                
                answers.push({
                    question: q,
                    userAnswer: userAnswer,
                    correct: true,
                    time: timeTaken
                });
                
                // Remove from weak areas if answered quickly and correctly
                if (timeTaken <= timings.ACCOMPLISHED) {
                    const key = `${q.num1}|${q.num2}|${q.op}|${q.answer}`;
                    const studentLevel = studentData.students[currentUser].levels[currentLevel];
                    delete studentLevel.weakAreas[key];
                }
                
                // Move to next question after a short delay
                setTimeout(() => {
                    currentQuestion++;
                    showNextQuestion();
                }, 500);
            } else {
                // Check if the user has entered a complete wrong answer (not just typing)
                const answerStr = userAnswer.toString();
                const correctStr = q.answer.toString();
                
                // If user's answer has same or more digits than correct answer, it's wrong
                if (answerStr.length >= correctStr.length && userAnswer !== q.answer) {
                    feedback.innerHTML = `âœ— Incorrect. The answer is <strong>${q.answer}</strong>`;
                    feedback.style.color = '#dc3545';
                    
                    // Record the answer and move to next question after showing correct answer
                    clearInterval(timerInterval);
                    const timeTaken = (Date.now() - startTime) / 1000;
                    
                    answers.push({
                        question: q,
                        userAnswer: userAnswer,
                        correct: false,
                        time: timeTaken
                    });
                    
                    // Track weak areas
                    const key = `${q.num1}|${q.num2}|${q.op}|${q.answer}`;
                    const studentLevel = studentData.students[currentUser].levels[currentLevel];
                    studentLevel.weakAreas[key] = (studentLevel.weakAreas[key] || 0) + 1;
                    
                    // Move to next question after showing correct answer
                    setTimeout(() => {
                        currentQuestion++;
                        showNextQuestion();
                    }, 2000);
                }
            }
        }
        
        function submitAnswer() {
            // This function is no longer needed but kept for compatibility
            checkAnswer();
        }
        
        function checkEnter(event) {
            // This function is no longer needed but kept for compatibility
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }
        
        function showResults() {
            clearInterval(timerInterval);
            
            const correctCount = answers.filter(a => a.correct).length;
            const totalTime = answers.reduce((sum, a) => sum + a.time, 0);
            const avgTime = totalTime / answers.length;
            const accuracy = (correctCount / answers.length) * 100;
            
            let mastery = null;
            if (accuracy >= 80) {
                if (avgTime <= timings.MASTERY) {
                    mastery = 'MASTERY';
                } else if (avgTime <= timings.ACCOMPLISHED) {
                    mastery = 'ACCOMPLISHED';
                } else if (avgTime <= timings.BASIC) {
                    mastery = 'BASIC';
                }
            }
            
            // Update student data
            const studentLevel = studentData.students[currentUser].levels[currentLevel];
            studentLevel.attempts.push({
                date: new Date().toISOString(),
                correctCount: correctCount,
                avgTime: avgTime,
                accuracy: accuracy,
                mastery: mastery
            });
            
            // Update mastery level
            if (mastery && (!studentLevel.mastery || 
                (mastery === 'MASTERY') ||
                (mastery === 'ACCOMPLISHED' && studentLevel.mastery === 'BASIC'))) {
                studentLevel.mastery = mastery;
            }
            
            // Unlock next level if ACCOMPLISHED or MASTERY
            if (mastery === 'ACCOMPLISHED' || mastery === 'MASTERY') {
                const levelKeys = Object.keys(levels);
                const currentIndex = levelKeys.indexOf(currentLevel);
                if (currentIndex < levelKeys.length - 1) {
                    const nextLevel = levelKeys[currentIndex + 1];
                    studentData.students[currentUser].levels[nextLevel].unlocked = true;
                }
            }
            
            // Display results
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('avg-time').textContent = avgTime.toFixed(1) + 's';
            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + '%';
            
            const badgeDiv = document.getElementById('mastery-badge');
            if (mastery) {
                badgeDiv.innerHTML = `<div class="mastery-badge mastery-${mastery.toLowerCase()}">${mastery}</div>`;
            } else {
                badgeDiv.innerHTML = '<p style="color: #666;">Keep practicing to achieve a mastery level!</p>';
            }
            
            showScreen('results-screen');
        }
        
        function endSession() {
            if (confirm('Are you sure you want to end this session? Your progress will not be saved.')) {
                clearInterval(timerInterval);
                backToLevelSelect();
            }
        }
        
        function backToLevelSelect() {
            showLevelSelect();
        }
        
        function retryLevel() {
            startLevel(currentLevel);
        }
        
        function showTeacherView() {
            const statsDiv = document.getElementById('teacher-stats');
            let html = '<h3>Student Progress Overview</h3>';
            
            if (Object.keys(studentData.students).length === 0) {
                html += '<p style="color: #666; padding: 20px;">No student data available yet.</p>';
            } else {
                for (let studentName in studentData.students) {
                    const student = studentData.students[studentName];
                    html += `<div class="student-card">
                        <h4>${studentName}</h4>`;
                    
                    for (let levelKey in student.levels) {
                        const level = student.levels[levelKey];
                        if (level.attempts.length > 0) {
                            const lastAttempt = level.attempts[level.attempts.length - 1];
                            html += `
                                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                    <strong>${levels[levelKey].name}</strong>: 
                                    ${level.mastery ? `<span class="mastery-badge mastery-${level.mastery.toLowerCase()}" style="font-size: 12px; padding: 3px 10px;">${level.mastery}</span>` : 'In Progress'}
                                    <br>
                                    <small>Last: ${lastAttempt.correctCount}/10 correct, ${lastAttempt.avgTime.toFixed(1)}s avg, ${level.attempts.length} attempts</small>
                                </div>`;
                        }
                    }
                    
                    html += '</div>';
                }
            }
            
            statsDiv.innerHTML = html;
            showScreen('teacher-view');
        }
    </script>
</body>
</html>
